<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app">
        <header class="shared-header">
            <div class="garland">
                <div class="garland-wire"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
            </div>
            <div class="shared-avatar mascot" id="userAvatar">üêª‚Äç‚ùÑÔ∏è</div>
            <h1 class="shared-name" id="userName">–í–∏—à–ª–∏—Å—Ç</h1>
            <p class="shared-subtitle">–í—ã–±–µ—Ä–∏ —á—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–¥–∞—Ä–∏—Ç—å</p>
        </header>

        <div class="section" style="margin-top: 20px;">
            <div id="wishesList"></div>
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">üîí</div>
                <h3>–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</h3>
                <p>–í–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç</p>
            </div>
        </div>

        <div class="modal" id="giftModal">
            <div class="modal-overlay"></div>
            <div class="modal-content" style="max-height: 50vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>–ü–æ–¥–∞—Ä–∏—Ç—å?</h2>
                    <button class="modal-close" id="closeGiftModal">√ó</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ —É–∑–Ω–∞–µ—Ç –∫—Ç–æ —ç—Ç–æ, –Ω–æ –∂–µ–ª–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω–æ
                    </p>
                    <div id="giftPreview" style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: left;"></div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancelGift">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" id="confirmGift">üéÅ –ü–æ–¥–∞—Ä—é!</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const haptic = {
            medium: () => tg?.HapticFeedback?.impactOccurred('medium'),
            success: () => tg?.HapticFeedback?.notificationOccurred('success')
        };

        const params = new URLSearchParams(window.location.search);
        const ownerTelegramId = params.get('user'); // telegram_id –≤–ª–∞–¥–µ–ª—å—Ü–∞
        const viewerId = tg?.initDataUnsafe?.user?.id || 'anon_' + Math.random().toString(36).substring(2, 9);

        let wishes = [];
        let selectedId = null;
        let ownerUserId = null; // UUID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ Supabase

        const $ = id => document.getElementById(id);
        const giftModal = $('giftModal');
        const toast = $('toast');

        async function init() {
            setupEvents();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ Supabase
            await loadOwnerData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∂–µ–ª–∞–Ω–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
            await loadOwnerWishes();
            
            render();
        }
        
        async function loadOwnerData() {
            if (!ownerTelegramId) {
                $('userName').textContent = '–í–∏—à–ª–∏—Å—Ç';
                return;
            }
            
            // –ñ–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase
            await new Promise(r => setTimeout(r, 100));
            
            const sb = window.supabaseClient;
            if (!sb) {
                console.log('No supabase client');
                return;
            }
            
            try {
                const { data: owner, error } = await sb
                    .from('users')
                    .select('*')
                    .eq('telegram_id', ownerTelegramId)
                    .single();
                
                console.log('Owner data:', owner, error);
                
                if (owner) {
                    ownerUserId = owner.id;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è
                    $('userName').textContent = owner.first_name || '–í–∏—à–ª–∏—Å—Ç';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
                    if (owner.photo_url) {
                        const avatar = $('userAvatar');
                        avatar.innerHTML = `<img src="${owner.photo_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        avatar.classList.remove('mascot');
                    }
                }
            } catch (err) {
                console.error('Load owner error:', err);
            }
        }
        
        async function loadOwnerWishes() {
            if (!ownerUserId) {
                console.log('No owner user id');
                return;
            }
            
            const sb = window.supabaseClient;
            if (!sb) return;
            
            try {
                const { data, error } = await sb
                    .from('wishes')
                    .select('*')
                    .eq('user_id', ownerUserId)
                    .order('created_at', { ascending: false });
                
                console.log('Owner wishes:', data, error);
                
                if (data) {
                    wishes = data.map(w => ({
                        id: w.id,
                        name: w.name,
                        description: w.description,
                        price: w.price,
                        currency: w.currency || '‚ÇΩ',
                        url: w.url,
                        photo: w.photo_url,
                        reserved: w.reserved,
                        reservedBy: w.reserved_by
                    }));
                }
            } catch (err) {
                console.error('Load wishes error:', err);
            }
        }

        function setupEvents() {
            $('closeGiftModal').onclick = closeModal;
            $('cancelGift').onclick = closeModal;
            giftModal.querySelector('.modal-overlay').onclick = closeModal;
            $('confirmGift').onclick = confirmGift;
        }

        function render() {
            const list = $('wishesList');
            const empty = $('emptyState');
            
            if (wishes.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            const available = wishes.filter(w => !w.reserved);
            const reserved = wishes.filter(w => w.reserved);
            
            let html = available.map((w, i) => createCard(w, false, i)).join('');
            
            if (reserved.length > 0) {
                html += `<div style="padding: 16px 0 8px; color: var(--text-secondary); font-size: 13px;">üéÅ –£–∂–µ —Ö–æ—Ç—è—Ç –ø–æ–¥–∞—Ä–∏—Ç—å (${reserved.length})</div>`;
                html += reserved.map((w, i) => createCard(w, true, i)).join('');
            }
            
            list.innerHTML = html;
            
            document.querySelectorAll('.btn-gift:not(.gifted)').forEach(btn => {
                btn.onclick = (e) => {
                    haptic.medium();
                    openModal(e.target.closest('.card').dataset.id);
                };
            });
        }

        function createCard(wish, isReserved, i) {
            const img = wish.photo 
                ? `<img src="${wish.photo}" class="card-image">` 
                : `<div class="card-image-placeholder">${isReserved ? '‚úì' : 'üéÅ'}</div>`;
            const price = wish.price ? `<span class="card-price">${Number(wish.price).toLocaleString('ru-RU')} ${wish.currency}</span>` : '';
            const desc = wish.description ? `<p class="card-subtitle">${wish.description}</p>` : '';
            const btn = isReserved 
                ? `<button class="btn btn-large btn-secondary btn-gift gifted" disabled>‚úì –ö—Ç–æ-—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç</button>`
                : `<button class="btn btn-large btn-success btn-gift">üéÅ –•–æ—á—É –ø–æ–¥–∞—Ä–∏—Ç—å</button>`;
            
            return `
                <div class="card ${isReserved ? 'reserved' : ''}" data-id="${wish.id}" style="opacity: ${isReserved ? '0.6' : '1'};">
                    ${!isReserved ? img : ''}
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 8px;">
                            <h3 class="card-title">${wish.name}</h3>
                            ${price}
                        </div>
                        ${desc}
                        <div style="margin-top: 12px;">${btn}</div>
                    </div>
                </div>
            `;
        }

        function openModal(wishId) {
            selectedId = wishId;
            const wish = wishes.find(w => w.id === wishId);
            if (wish) {
                $('giftPreview').innerHTML = `
                    <strong>${wish.name}</strong>
                    ${wish.price ? `<br><span style="color: var(--ios-orange);">${Number(wish.price).toLocaleString('ru-RU')} ${wish.currency}</span>` : ''}
                `;
                giftModal.classList.add('active');
            }
        }

        function closeModal() {
            giftModal.classList.remove('active');
            selectedId = null;
        }

        async function confirmGift() {
            if (!selectedId) return;
            haptic.success();
            
            const sb = window.supabaseClient;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
            if (sb) {
                try {
                    const { error } = await sb
                        .from('wishes')
                        .update({ reserved: true, reserved_by: viewerId.toString() })
                        .eq('id', selectedId);
                    
                    console.log('Reserve result:', error);
                } catch (err) {
                    console.error('Reserve error:', err);
                }
            }
            
            const idx = wishes.findIndex(w => w.id === selectedId);
            if (idx !== -1) {
                wishes[idx].reserved = true;
                wishes[idx].reservedBy = viewerId;
                render();
                closeModal();
                showToast('‚úì –û—Ç–ª–∏—á–Ω–æ! –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ —É–∑–Ω–∞–µ—Ç –∫—Ç–æ —ç—Ç–æ');
                confetti();
            }
        }

        function confetti() {
            const colors = ['#007aff', '#34c759', '#ff9500', '#ff3b30', '#af52de'];
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti';
                    c.style.left = Math.random() * 100 + 'vw';
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDuration = (Math.random() * 1.5 + 1.5) + 's';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 3000);
                }, i * 30);
            }
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2000);
        }

        init();
    </script>
    <script src="config.js"></script>
</body>
</html>
