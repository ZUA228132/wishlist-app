<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly - –ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app">
        <!-- Loading -->
        <div id="loading" class="empty-state active" style="padding: 80px 20px;">
            <div class="empty-icon">‚è≥</div>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
        </div>

        <!-- Not Found -->
        <div id="notFound" style="display: none;">
            <div class="empty-state active" style="padding: 80px 20px;">
                <div class="empty-icon">üòï</div>
                <h3>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</h3>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–∫—Ä—ã—Ç</p>
            </div>
        </div>

        <!-- Profile -->
        <div id="profileView" style="display: none;">
            <header class="profile-header">
                <div class="garland">
                    <div class="garland-wire"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                    <div class="garland-light"></div>
                </div>
                <div class="profile-avatar" id="profileAvatar">
                    <span id="avatarEmoji">üêª‚Äç‚ùÑÔ∏è</span>
                </div>
                <h1 class="profile-name">
                    <span id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
                </h1>
                <p class="profile-username" id="profileUsername">@username</p>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="wishesCount">0</div>
                        <div class="stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="giftedCount">0</div>
                        <div class="stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                    </div>
                </div>
            </header>

            <!-- Achievements -->
            <div class="section" id="achievementsSection">
                <div class="section-label">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>

            <!-- Wishlist -->
            <div class="section">
                <div class="section-label">üéÅ –í–∏—à–ª–∏—Å—Ç</div>
                <div id="wishesList"></div>
                <div class="empty-state" id="emptyWishes" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <h3>–í–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç</h3>
                </div>
            </div>

            <!-- CTA -->
            <div class="section" style="text-align: center; padding-bottom: 40px;">
                <a href="https://t.me/giftl_robot" class="btn btn-primary btn-large" style="display: inline-flex;">
                    üêª‚Äç‚ùÑÔ∏è –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –≤–∏—à–ª–∏—Å—Ç
                </a>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        const params = new URLSearchParams(window.location.search);
        const profileId = params.get('id'); // telegram_id
        
        async function init() {
            if (!profileId) {
                showNotFound();
                return;
            }
            
            await loadProfile();
        }
        
        async function loadProfile() {
            const sb = window.supabaseClient;
            if (!sb) {
                showNotFound();
                return;
            }
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const { data: user, error } = await sb
                    .from('users')
                    .select('*')
                    .eq('telegram_id', parseInt(profileId))
                    .single();
                
                if (error || !user) {
                    showNotFound();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å
                if (user.privacy === 'private') {
                    showNotFound();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
                if (user.is_blocked) {
                    showNotFound();
                    return;
                }
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                await sb
                    .from('users')
                    .update({ profile_views: (user.profile_views || 0) + 1 })
                    .eq('id', user.id);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∂–µ–ª–∞–Ω–∏—è
                const { data: wishes } = await sb
                    .from('wishes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                
                renderProfile(user, wishes || []);
                
            } catch (err) {
                console.error('Load profile error:', err);
                showNotFound();
            }
        }
        
        function renderProfile(user, wishes) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profileView').style.display = 'block';
            
            // –ò–º—è –∏ username
            document.getElementById('profileName').textContent = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('profileUsername').textContent = user.username ? `@${user.username}` : '';
            
            // –ê–≤–∞—Ç–∞—Ä
            if (user.photo_url) {
                document.getElementById('avatarEmoji').style.display = 'none';
                const img = document.createElement('img');
                img.src = user.photo_url;
                document.getElementById('profileAvatar').appendChild(img);
            }
            
            // –ì–∞–ª–æ—á–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            if (user.verified) {
                document.getElementById('verifiedBadge').style.display = 'inline-flex';
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('wishesCount').textContent = wishes.length;
            document.getElementById('giftedCount').textContent = wishes.filter(w => w.reserved).length;
            
            // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            renderAchievements(user, wishes);
            
            // –í–∏—à–ª–∏—Å—Ç
            renderWishes(wishes);
        }
        
        function renderAchievements(user, wishes) {
            const achievements = [
                { id: 'first', icon: 'üéÅ', name: '–ü–µ—Ä–≤–æ–µ', unlocked: wishes.length > 0 },
                { id: 'ten', icon: '‚≠ê', name: '10+', unlocked: wishes.length >= 10 },
                { id: 'gifted', icon: 'üíù', name: '–©–µ–¥—Ä—ã–π', unlocked: wishes.some(w => w.reserved) },
                { id: 'verified', icon: '‚úì', name: 'VIP', unlocked: user.verified }
            ];
            
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = achievements.map(a => `
                <div class="achievement ${a.unlocked ? '' : 'locked'}">
                    <div class="achievement-icon">${a.icon}</div>
                    <div class="achievement-name">${a.name}</div>
                </div>
            `).join('');
        }
        
        function renderWishes(wishes) {
            const list = document.getElementById('wishesList');
            const empty = document.getElementById('emptyWishes');
            
            if (wishes.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = wishes.map(w => `
                <div class="card ${w.reserved ? 'reserved' : ''}">
                    ${w.photo_url ? `<img src="${w.photo_url}" class="card-image">` : '<div class="card-image-placeholder">üéÅ</div>'}
                    <div class="card-body">
                        <div class="card-header-row">
                            <h3 class="card-title">${esc(w.name)}</h3>
                            ${w.price ? `<span class="card-price">${Number(w.price).toLocaleString('ru-RU')} ${w.currency || '‚ÇΩ'}</span>` : ''}
                        </div>
                        ${w.description ? `<p class="card-subtitle">${esc(w.description)}</p>` : ''}
                        ${w.url ? `<a href="${w.url}" target="_blank" class="card-link">üîó –ì–¥–µ –∫—É–ø–∏—Ç—å</a>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function showNotFound() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('notFound').style.display = 'block';
        }
        
        function esc(t) { 
            const d = document.createElement('div'); 
            d.textContent = t; 
            return d.innerHTML; 
        }
        
        init();
    </script>
</body>
</html>
