<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly - –ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Web Block Overlay -->
    <div id="webBlock" style="display: none; position: fixed; inset: 0; z-index: 9999; background: linear-gradient(180deg, #1e3a5f 0%, #2d4a6f 50%, #1a2f4a 100%); align-items: center; justify-content: center; flex-direction: column; padding: 40px; text-align: center;">
        <div style="font-size: 80px; margin-bottom: 20px;">üë§</div>
        <h1 style="color: white; font-size: 28px; margin-bottom: 16px;">–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <p style="color: rgba(255,255,255,0.8); font-size: 16px; margin-bottom: 32px; max-width: 300px;">
            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!
        </p>
        <a href="https://t.me/giftl_robot" style="background: linear-gradient(135deg, #165B33, #146B3A); color: white; padding: 16px 32px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 16px;">
            üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
        </a>
    </div>

    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app" id="mainApp">
        <nav class="bottom-nav" id="bottomNav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üéÅ</span>
                <span class="nav-label">–ñ–µ–ª–∞–Ω–∏—è</span>
            </a>
            <a href="santa.html" class="nav-item">
                <span class="nav-icon">üéÖ</span>
                <span class="nav-label">–°–∞–Ω—Ç–∞</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
        </nav>

        <header class="profile-header">
            <div class="garland">
                <div class="garland-wire"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
            </div>
            <div class="profile-avatar" id="profileAvatar">
                <span id="avatarEmoji">üêª‚Äç‚ùÑÔ∏è</span>
            </div>
            <h1 class="profile-name">
                <span id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
            </h1>
            <p class="profile-username" id="profileUsername">@username</p>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="wishesCount">0</div>
                    <div class="stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="giftedCount">0</div>
                    <div class="stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="santaCount">0</div>
                    <div class="stat-label">–ì—Ä—É–ø–ø</div>
                </div>
            </div>
        </header>

        <div class="section" style="margin-top: 24px;">
            <div class="section-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div class="achievements-grid">
                <div class="achievement locked" id="ach1"><div class="achievement-icon">üéÅ</div><div class="achievement-name">–ü–µ—Ä–≤–æ–µ</div></div>
                <div class="achievement locked" id="ach2"><div class="achievement-icon">üéÖ</div><div class="achievement-name">–°–∞–Ω—Ç–∞</div></div>
                <div class="achievement locked" id="ach3"><div class="achievement-icon">üíù</div><div class="achievement-name">–©–µ–¥—Ä—ã–π</div></div>
                <div class="achievement locked" id="ach4"><div class="achievement-icon">‚≠ê</div><div class="achievement-name">10+</div></div>
                <div class="achievement locked" id="ach5"><div class="achievement-icon">üéÑ</div><div class="achievement-name">–õ–∏–¥–µ—Ä</div></div>
                <div class="achievement locked" id="ach6"><div class="achievement-icon">üåü</div><div class="achievement-name">–ó–≤–µ–∑–¥–∞</div></div>
                <div class="achievement locked" id="ach7"><div class="achievement-icon">üíé</div><div class="achievement-name">VIP</div></div>
                <div class="achievement locked" id="ach8"><div class="achievement-icon">üèÜ</div><div class="achievement-name">–õ–µ–≥–µ–Ω–¥–∞</div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="list">
                <div class="list-item" id="menuShare">
                    <div class="list-icon blue">üì§</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
                        <div class="list-subtitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç –¥—Ä—É–∑—å—è–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuStory">
                    <div class="list-icon" style="background: linear-gradient(135deg, #c41e3a, #ff6b6b);">ÔøΩ</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Stories</div>
                        <div class="list-subtitle">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—è—Ö Telegram</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuChat">
                    <div class="list-icon" style="background: linear-gradient(135deg, #007aff, #5ac8fa);">üí¨</div>
                    <div class="list-content">
                        <div class="list-title">–û–±—â–∏–π —á–∞—Ç</div>
                        <div class="list-subtitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuPrivacy">
                    <div class="list-icon purple">üîí</div>
                    <div class="list-content">
                        <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>
                        <div class="list-subtitle" id="privacyStatus">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuSupport">
                    <div class="list-icon green">üí¨</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        <div class="list-subtitle">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- Admin Link (only for admin) -->
        <div class="section" id="adminSection" style="display: none;">
            <div class="section-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="list">
                <div class="list-item" onclick="location.href='admin.html'">
                    <div class="list-icon red">‚öôÔ∏è</div>
                    <div class="list-content">
                        <div class="list-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                        <div class="list-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <p style="text-align: center; color: var(--text-tertiary); font-size: 13px; padding: 20px;">
            <span class="mascot mascot-small">üêª‚Äç‚ùÑÔ∏è</span> Giftly v1.0
        </p>

        <!-- Story Editor Modal -->
        <div class="modal" id="storyModal">
            <div class="modal-overlay" onclick="closeStoryModal()"></div>
            <div class="modal-content" style="max-height: 90vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üì∏ –°–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</h2>
                    <button class="modal-close" onclick="closeStoryModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <!-- –í—ã–±–æ—Ä –∂–µ–ª–∞–Ω–∏—è -->
                    <div class="form-group">
                        <label class="form-label">–ñ–µ–ª–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <select id="storyWishSelect" class="form-input" onchange="updateStoryCanvas()">
                            <option value="">-- –ë–µ–∑ –∂–µ–ª–∞–Ω–∏—è --</option>
                        </select>
                    </div>
                    
                    <!-- –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ -->
                    <div class="form-group">
                        <label class="form-label">–®–∞–±–ª–æ–Ω</label>
                        <div class="story-templates" style="display: flex; gap: 10px; overflow-x: auto; padding: 8px 0;">
                            <div class="story-tpl active" data-bg="green" onclick="selectStoryTemplate(this)" style="width:54px;height:76px;border-radius:12px;border:2px solid white;cursor:pointer;background:linear-gradient(135deg,#165B33,#0B3D2E);"></div>
                            <div class="story-tpl" data-bg="red" onclick="selectStoryTemplate(this)" style="width:54px;height:76px;border-radius:12px;border:2px solid transparent;cursor:pointer;background:linear-gradient(135deg,#c41e3a,#ff6b6b);"></div>
                            <div class="story-tpl" data-bg="blue" onclick="selectStoryTemplate(this)" style="width:54px;height:76px;border-radius:12px;border:2px solid transparent;cursor:pointer;background:linear-gradient(135deg,#4facfe,#00f2fe);"></div>
                            <div class="story-tpl" data-bg="purple" onclick="selectStoryTemplate(this)" style="width:54px;height:76px;border-radius:12px;border:2px solid transparent;cursor:pointer;background:linear-gradient(135deg,#667eea,#764ba2);"></div>
                            <div class="story-tpl" data-bg="gold" onclick="selectStoryTemplate(this)" style="width:54px;height:76px;border-radius:12px;border:2px solid transparent;cursor:pointer;background:linear-gradient(135deg,#f5af19,#f12711);"></div>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–µ–≤—å—é -->
                    <div style="display:flex;justify-content:center;margin:16px 0;">
                        <canvas id="storyCanvas" width="360" height="640" style="border-radius:16px;max-width:100%;"></canvas>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="downloadStoryImage()">üì• –°–∫–∞—á–∞—Ç—å</button>
                        <button type="button" class="btn btn-primary" onclick="shareStoryToTelegram()">üì§ –í Stories</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Modal -->
        <div class="modal" id="privacyModal">
            <div class="modal-overlay" onclick="closePrivacyModal()"></div>
            <div class="modal-content" style="max-height: 55vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üîí –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h2>
                    <button class="modal-close" onclick="closePrivacyModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="list">
                        <div class="list-item privacy-option" data-value="public">
                            <div class="list-icon blue">üåç</div>
                            <div class="list-content">
                                <div class="list-title">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                                <div class="list-subtitle">–õ—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å</div>
                            </div>
                            <span class="privacy-check" id="check-public">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="friends">
                            <div class="list-icon green">üë•</div>
                            <div class="list-content">
                                <div class="list-title">–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</div>
                                <div class="list-subtitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram</div>
                            </div>
                            <span class="privacy-check" id="check-friends" style="display:none;">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="private">
                            <div class="list-icon purple">üîê</div>
                            <div class="list-content">
                                <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>
                                <div class="list-subtitle">–¢–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ</div>
                            </div>
                            <span class="privacy-check" id="check-private" style="display:none;">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const ADMIN_ID = '7086128174';
        
        const state = {
            userId: tg?.initDataUnsafe?.user?.id?.toString() || 'demo',
            userName: tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: tg?.initDataUnsafe?.user?.username || 'user',
            photoUrl: tg?.initDataUnsafe?.user?.photo_url || null,
            privacy: localStorage.getItem('privacy') || 'public'
        };

        const haptic = {
            light: () => tg?.HapticFeedback?.impactOccurred('light'),
            success: () => tg?.HapticFeedback?.notificationOccurred('success')
        };

        function init() {
            loadProfile();
            loadStats();
            checkVerified();
            checkAdmin();
            checkAchievements();
            setupEvents();
            updatePrivacyStatus();
        }

        function loadProfile() {
            document.getElementById('profileName').textContent = state.userName;
            document.getElementById('profileUsername').textContent = `@${state.username}`;
            
            if (state.photoUrl) {
                document.getElementById('avatarEmoji').style.display = 'none';
                const img = document.createElement('img');
                img.src = state.photoUrl;
                document.getElementById('profileAvatar').appendChild(img);
            }
        }

        function loadStats() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            animateValue('wishesCount', 0, wishes.length, 600);
            animateValue('giftedCount', 0, gifted, 600);
            animateValue('santaCount', 0, groups.length, 600);
        }

        function animateValue(id, start, end, duration) {
            const el = document.getElementById(id);
            if (!el) return;
            if (start === end) { el.textContent = end; return; }
            
            const startTime = performance.now();
            const range = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(start + range * eased);
                if (progress < 1) requestAnimationFrame(update);
            }
            
            requestAnimationFrame(update);
        }

        function checkVerified() {
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            const isVerified = verified.some(u => u.id === state.userId);
            document.getElementById('verifiedBadge').style.display = isVerified ? 'inline-flex' : 'none';
        }

        function checkAdmin() {
            // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω —á–µ—Ä–µ–∑ Telegram
            const isAdmin = tg && tg.initDataUnsafe?.user && state.userId === ADMIN_ID;
            document.getElementById('adminSection').style.display = isAdmin ? 'block' : 'none';
        }

        function checkAchievements() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            if (wishes.length > 0) document.getElementById('ach1').classList.remove('locked');
            if (groups.length > 0) document.getElementById('ach2').classList.remove('locked');
            if (gifted > 0) document.getElementById('ach3').classList.remove('locked');
            if (wishes.length >= 10) document.getElementById('ach4').classList.remove('locked');
            
            const created = groups.filter(g => g.adminId === state.userId);
            if (created.length > 0) document.getElementById('ach5').classList.remove('locked');
        }

        function setupEvents() {
            document.getElementById('menuShare').onclick = () => {
                haptic.light();
                shareProfile();
            };
            
            document.getElementById('menuStory').onclick = () => {
                haptic.light();
                openStoryEditor();
            };
            
            document.getElementById('menuChat').onclick = () => {
                haptic.light();
                if (tg) tg.openTelegramLink('https://t.me/giftly_chat');
                else window.open('https://t.me/giftly_chat', '_blank');
            };
            
            document.getElementById('menuPrivacy').onclick = () => {
                haptic.light();
                openPrivacyModal();
            };
            
            document.getElementById('menuSupport').onclick = () => {
                haptic.light();
                if (tg) tg.openTelegramLink('https://t.me/pravy_ru');
                else window.open('https://t.me/pravy_ru', '_blank');
            };
            
            // Achievement clicks
            document.querySelectorAll('.achievement').forEach(ach => {
                ach.onclick = () => {
                    haptic.light();
                    const name = ach.querySelector('.achievement-name').textContent;
                    const isLocked = ach.classList.contains('locked');
                    showToast(isLocked ? `üîí ${name} - –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ` : `‚úÖ ${name}`);
                };
            });

            // Privacy options
            document.querySelectorAll('.privacy-option').forEach(opt => {
                opt.onclick = () => {
                    const value = opt.dataset.value;
                    setPrivacy(value);
                };
            });
        }
        
        // –®–µ—Ä–∏–Ω–≥ –≤ Telegram Stories
        async function shareToStory() {
            const botUsername = window.BOT_USERNAME || 'giftl_robot';
            const botUrl = `https://t.me/${botUsername}?start=wishlist_${state.userId}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Telegram (shareToStory –¥–æ—Å—Ç—É–ø–µ–Ω —Å –≤–µ—Ä—Å–∏–∏ 7.8)
            const version = tg?.version || '0.0';
            const [major, minor] = version.split('.').map(Number);
            const supportsStory = major > 7 || (major === 7 && minor >= 8);
            
            if (!tg || !supportsStory) {
                showToast('–û–±–Ω–æ–≤–∏—Ç–µ Telegram –¥–ª—è Stories');
                return;
            }
            
            showToast('üì∏ –°–æ–∑–¥–∞—ë–º –∏—Å—Ç–æ—Ä–∏—é...');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const topWish = wishes.find(w => !w.reserved);
            
            const canvas = document.createElement('canvas');
            canvas.width = 720;
            canvas.height = 1280;
            const ctx = canvas.getContext('2d');
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
            const gradient = ctx.createLinearGradient(0, 0, 0, 1280);
            gradient.addColorStop(0, '#165B33');
            gradient.addColorStop(0.5, '#146B3A');
            gradient.addColorStop(1, '#0B3D2E');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 720, 1280);
            
            // –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫—Ä—É–≥–∏
            ctx.globalAlpha = 0.1;
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(100, 200, 150, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(620, 1100, 200, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ctx.fillStyle = 'white';
            ctx.font = 'bold 64px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Giftly üéÅ', 360, 280);
            
            // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            ctx.font = '36px -apple-system, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillText(`–í–∏—à–ª–∏—Å—Ç ${state.userName}`, 360, 350);
            
            // –ö–∞—Ä—Ç–æ—á–∫–∞ –∂–µ–ª–∞–Ω–∏—è
            ctx.fillStyle = 'rgba(255,255,255,0.15)';
            roundRect(ctx, 80, 420, 560, 400, 30);
            ctx.fill();
            
            if (topWish) {
                // –≠–º–æ–¥–∑–∏ –ø–æ–¥–∞—Ä–∫–∞
                ctx.font = '120px serif';
                ctx.fillText('üéÅ', 360, 580);
                
                // –ù–∞–∑–≤–∞–Ω–∏–µ –∂–µ–ª–∞–Ω–∏—è
                ctx.fillStyle = 'white';
                ctx.font = 'bold 36px -apple-system, sans-serif';
                const wishName = topWish.name.length > 25 ? topWish.name.substring(0, 22) + '...' : topWish.name;
                ctx.fillText(wishName, 360, 680);
                
                // –¶–µ–Ω–∞
                if (topWish.price) {
                    ctx.font = 'bold 32px -apple-system, sans-serif';
                    ctx.fillStyle = '#FFD700';
                    ctx.fillText(`${Number(topWish.price).toLocaleString('ru-RU')} ${topWish.currency || '‚ÇΩ'}`, 360, 740);
                }
            } else {
                // –ú–∏—à–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç –∂–µ–ª–∞–Ω–∏–π
                ctx.font = '150px serif';
                ctx.fillText('üêª‚Äç‚ùÑÔ∏è', 360, 650);
                
                ctx.fillStyle = 'white';
                ctx.font = '28px -apple-system, sans-serif';
                ctx.fillText('–°–æ–∑–¥–∞–π —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π!', 360, 770);
            }
            
            // CTA –∫–Ω–æ–ø–∫–∞
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            roundRect(ctx, 160, 900, 400, 70, 35);
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 26px -apple-system, sans-serif';
            ctx.fillText('–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç ‚Üí', 360, 945);
            
            // –°–Ω–µ–∂–∏–Ω–∫–∏
            ctx.font = '40px serif';
            ctx.globalAlpha = 0.3;
            ctx.fillText('‚ùÑÔ∏è', 80, 500);
            ctx.fillText('‚ùÑÔ∏è', 640, 400);
            ctx.fillText('‚≠ê', 100, 950);
            ctx.fillText('‚ú®', 620, 850);
            ctx.fillText('üéÑ', 80, 1150);
            ctx.fillText('üéÅ', 640, 1100);
            ctx.globalAlpha = 1;
            
            // –§—É—Ç–µ—Ä
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '24px -apple-system, sans-serif';
            ctx.fillText(`@${state.username}`, 360, 1200);
            
            function roundRect(ctx, x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
            }
            
            try {
                const base64 = canvas.toDataURL('image/png');
                
                tg.shareToStory(base64, {
                    text: 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!\n\n–°–æ–∑–¥–∞–π —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π üéÑ',
                    widget_link: {
                        url: botUrl,
                        name: '–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç'
                    }
                });
                haptic.success();
            } catch (e) {
                console.error('Story error:', e);
                showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
            }
        }
        
        function shareProfile() {
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏—à–ª–∏—Å—Ç–∞
            const botUsername = window.BOT_USERNAME || 'giftly_wishlist_bot';
            const botUrl = `https://t.me/${botUsername}?start=wishlist_${state.userId}`;
            const text = 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!';
            
            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(botUrl)}&text=${encodeURIComponent(text)}`);
            } else if (navigator.share) {
                navigator.share({ title: 'Giftly', text, url: botUrl });
            } else {
                navigator.clipboard.writeText(botUrl);
                showToast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
            }
        }

        function openPrivacyModal() {
            updatePrivacyChecks();
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function setPrivacy(value) {
            state.privacy = value;
            localStorage.setItem('privacy', value);
            updatePrivacyChecks();
            updatePrivacyStatus();
            haptic.success();
            showToast('‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            closePrivacyModal();
        }

        function updatePrivacyChecks() {
            document.getElementById('check-public').style.display = state.privacy === 'public' ? 'inline' : 'none';
            document.getElementById('check-friends').style.display = state.privacy === 'friends' ? 'inline' : 'none';
            document.getElementById('check-private').style.display = state.privacy === 'private' ? 'inline' : 'none';
        }

        function updatePrivacyStatus() {
            const labels = { public: '–ü—É–±–ª–∏—á–Ω—ã–π', friends: '–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è', private: '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' };
            document.getElementById('privacyStatus').textContent = labels[state.privacy] || '–ü—É–±–ª–∏—á–Ω—ã–π';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2000);
        }

        // ===== STORY EDITOR =====
        let currentStoryBg = 'green';
        
        function openStoryEditor() {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const select = document.getElementById('storyWishSelect');
            select.innerHTML = '<option value="">-- –ë–µ–∑ –∂–µ–ª–∞–Ω–∏—è --</option>' + 
                wishes.filter(w => !w.reserved).map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            
            document.getElementById('storyModal').classList.add('active');
            updateStoryCanvas();
        }
        
        function closeStoryModal() {
            document.getElementById('storyModal').classList.remove('active');
        }
        
        function selectStoryTemplate(el) {
            document.querySelectorAll('.story-tpl').forEach(t => t.style.borderColor = 'transparent');
            el.style.borderColor = 'white';
            currentStoryBg = el.dataset.bg;
            haptic.light();
            updateStoryCanvas();
        }
        
        function updateStoryCanvas() {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            const w = 360, h = 640;
            
            // –¶–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
            const bgs = {
                green: ['#165B33', '#146B3A', '#0B3D2E'],
                red: ['#c41e3a', '#e74c3c', '#ff6b6b'],
                blue: ['#4facfe', '#00c6fb', '#00f2fe'],
                purple: ['#667eea', '#764ba2', '#6B73FF'],
                gold: ['#f5af19', '#f12711', '#ff6b35']
            };
            const colors = bgs[currentStoryBg] || bgs.green;
            
            // –ì—Ä–∞–¥–∏–µ–Ω—Ç
            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(0.5, colors[1]);
            gradient.addColorStop(1, colors[2]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
            
            // –î–µ–∫–æ—Ä
            ctx.globalAlpha = 0.1;
            ctx.fillStyle = '#FFD700';
            ctx.beginPath(); ctx.arc(50, 100, 80, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(310, 550, 100, 0, Math.PI * 2); ctx.fill();
            ctx.globalAlpha = 1;
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ctx.fillStyle = 'white';
            ctx.font = 'bold 32px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Giftly üéÅ', w/2, 140);
            
            // –ò–º—è
            ctx.font = '18px -apple-system, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillText(`–í–∏—à–ª–∏—Å—Ç ${state.userName}`, w/2, 175);
            
            // –ö–∞—Ä—Ç–æ—á–∫–∞
            ctx.fillStyle = 'rgba(255,255,255,0.15)';
            roundRect(ctx, 40, 210, 280, 200, 15);
            ctx.fill();
            
            // –ñ–µ–ª–∞–Ω–∏–µ
            const wishId = document.getElementById('storyWishSelect').value;
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const wish = wishes.find(w => w.id === wishId);
            
            if (wish) {
                ctx.font = '60px serif';
                ctx.fillText('üéÅ', w/2, 290);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 18px -apple-system, sans-serif';
                const name = wish.name.length > 20 ? wish.name.substring(0, 17) + '...' : wish.name;
                ctx.fillText(name, w/2, 340);
                
                if (wish.price) {
                    ctx.font = 'bold 16px -apple-system, sans-serif';
                    ctx.fillStyle = '#FFD700';
                    ctx.fillText(`${Number(wish.price).toLocaleString('ru-RU')} ${wish.currency || '‚ÇΩ'}`, w/2, 375);
                }
            } else {
                ctx.font = '80px serif';
                ctx.fillText('üêª‚Äç‚ùÑÔ∏è', w/2, 320);
                
                ctx.fillStyle = 'white';
                ctx.font = '14px -apple-system, sans-serif';
                ctx.fillText('–°–æ–∑–¥–∞–π —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π!', w/2, 385);
            }
            
            // CTA
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            roundRect(ctx, 80, 450, 200, 35, 18);
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 13px -apple-system, sans-serif';
            ctx.fillText('–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç ‚Üí', w/2, 473);
            
            // –î–µ–∫–æ—Ä
            ctx.font = '20px serif';
            ctx.globalAlpha = 0.3;
            ctx.fillText('‚ùÑÔ∏è', 40, 250);
            ctx.fillText('‚≠ê', 320, 220);
            ctx.fillText('üéÑ', 40, 575);
            ctx.fillText('‚ú®', 310, 480);
            ctx.globalAlpha = 1;
            
            // –§—É—Ç–µ—Ä
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.fillText(`@${state.username}`, w/2, 600);
            
            function roundRect(ctx, x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
            }
        }
        
        function downloadStoryImage() {
            haptic.success();
            const canvas = document.getElementById('storyCanvas');
            const link = document.createElement('a');
            link.download = 'giftly-story.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('üì• –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }
        
        function shareStoryToTelegram() {
            const botUsername = window.BOT_USERNAME || 'giftl_robot';
            const botUrl = `https://t.me/${botUsername}?start=wishlist_${state.userId}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Stories
            const version = tg?.version || '0.0';
            const [major, minor] = version.split('.').map(Number);
            const supportsStory = major > 7 || (major === 7 && minor >= 8);
            
            if (!tg || !supportsStory) {
                // Fallback - —Å–∫–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
                downloadStoryImage();
                showToast('–î–æ–±–∞–≤—å –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ Stories –≤—Ä—É—á–Ω—É—é');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è Stories (720x1280)
            const canvas = document.createElement('canvas');
            canvas.width = 720;
            canvas.height = 1280;
            const ctx = canvas.getContext('2d');
            
            // –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            const preview = document.getElementById('storyCanvas');
            ctx.drawImage(preview, 0, 0, 720, 1280);
            
            try {
                const base64 = canvas.toDataURL('image/png');
                
                tg.shareToStory(base64, {
                    text: 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!',
                    widget_link: {
                        url: botUrl,
                        name: '–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç'
                    }
                });
                haptic.success();
                closeStoryModal();
            } catch (e) {
                console.error('Story error:', e);
                showToast('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–µ–±-–≤–µ—Ä—Å–∏–∏
        if (!tg || !tg.initDataUnsafe?.user) {
            document.getElementById('webBlock').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
        } else {
            document.getElementById('webBlock').style.display = 'none';
        }
        
        init();
    </script>

    <script src="config.js"></script>
    <style>
        .privacy-check { color: #667eea; font-weight: bold; }
    </style>
</body>
</html>
