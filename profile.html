<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly - –ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <!-- Web Block Overlay -->
    <div id="webBlock" style="display: none; position: fixed; inset: 0; z-index: 9999; background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%); align-items: center; justify-content: center; flex-direction: column; padding: 40px; text-align: center;">
        <div style="font-size: 80px; margin-bottom: 20px;">üë§</div>
        <h1 style="color: #1b5e20; font-size: 28px; margin-bottom: 16px;">–ü—Ä–æ—Ñ–∏–ª—å</h1>
        <p style="color: #388e3c; font-size: 16px; margin-bottom: 32px; max-width: 300px;">
            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!
        </p>
        <a href="https://t.me/giftl_robot" style="background: #34c759; color: white; padding: 16px 32px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 16px;">
            üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
        </a>
    </div>

    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app" id="mainApp">
        <nav class="bottom-nav" id="bottomNav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üéÅ</span>
                <span class="nav-label">–ñ–µ–ª–∞–Ω–∏—è</span>
            </a>
            <a href="santa.html" class="nav-item">
                <span class="nav-icon">üéÖ</span>
                <span class="nav-label">–°–∞–Ω—Ç–∞</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
        </nav>

        <header class="profile-header">
            <div class="garland">
                <div class="garland-wire"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
            </div>
            <div class="profile-avatar" id="profileAvatar">
                <span id="avatarEmoji">üêª‚Äç‚ùÑÔ∏è</span>
            </div>
            <h1 class="profile-name">
                <span id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
            </h1>
            <p class="profile-username" id="profileUsername">@username</p>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="wishesCount">0</div>
                    <div class="stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="giftedCount">0</div>
                    <div class="stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="santaCount">0</div>
                    <div class="stat-label">–ì—Ä—É–ø–ø</div>
                </div>
            </div>
        </header>

        <div class="section" style="margin-top: 24px;">
            <div class="section-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div class="achievements-grid">
                <div class="achievement locked" id="ach1"><div class="achievement-icon">üéÅ</div><div class="achievement-name">–ü–µ—Ä–≤–æ–µ</div></div>
                <div class="achievement locked" id="ach2"><div class="achievement-icon">üéÖ</div><div class="achievement-name">–°–∞–Ω—Ç–∞</div></div>
                <div class="achievement locked" id="ach3"><div class="achievement-icon">üíù</div><div class="achievement-name">–©–µ–¥—Ä—ã–π</div></div>
                <div class="achievement locked" id="ach4"><div class="achievement-icon">‚≠ê</div><div class="achievement-name">10+</div></div>
                <div class="achievement locked" id="ach5"><div class="achievement-icon">üéÑ</div><div class="achievement-name">–õ–∏–¥–µ—Ä</div></div>
                <div class="achievement locked" id="ach6"><div class="achievement-icon">üåü</div><div class="achievement-name">–ó–≤–µ–∑–¥–∞</div></div>
                <div class="achievement locked" id="ach7"><div class="achievement-icon">üíé</div><div class="achievement-name">VIP</div></div>
                <div class="achievement locked" id="ach8"><div class="achievement-icon">üèÜ</div><div class="achievement-name">–õ–µ–≥–µ–Ω–¥–∞</div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="list">
                <div class="list-item" id="menuShare">
                    <div class="list-icon blue">üì§</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
                        <div class="list-subtitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç –¥—Ä—É–∑—å—è–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuStory">
                    <div class="list-icon" style="background: linear-gradient(135deg, #c41e3a, #ff6b6b);">ÔøΩ</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Stories</div>
                        <div class="list-subtitle">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—è—Ö Telegram</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuChat">
                    <div class="list-icon" style="background: linear-gradient(135deg, #007aff, #5ac8fa);">üí¨</div>
                    <div class="list-content">
                        <div class="list-title">–û–±—â–∏–π —á–∞—Ç</div>
                        <div class="list-subtitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuPrivacy">
                    <div class="list-icon purple">üîí</div>
                    <div class="list-content">
                        <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>
                        <div class="list-subtitle" id="privacyStatus">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuSupport">
                    <div class="list-icon green">üí¨</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        <div class="list-subtitle">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuVerify">
                    <div class="list-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">‚úì</div>
                    <div class="list-content">
                        <div class="list-title">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≥–∞–ª–æ—á–∫—É</div>
                        <div class="list-subtitle" id="verifyStatus">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- Admin Link (only for admin) -->
        <div class="section" id="adminSection" style="display: none;">
            <div class="section-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="list">
                <div class="list-item" onclick="location.href='admin.html'">
                    <div class="list-icon red">‚öôÔ∏è</div>
                    <div class="list-content">
                        <div class="list-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                        <div class="list-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <p style="text-align: center; color: var(--text-tertiary); font-size: 13px; padding: 20px;">
            <span class="mascot mascot-small">üêª‚Äç‚ùÑÔ∏è</span> Giftly v1.0
        </p>

        <!-- Story Editor Modal -->
        <div class="modal" id="storyModal">
            <div class="modal-overlay" onclick="closeStoryModal()"></div>
            <div class="modal-content" style="max-height: 90vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üì∏ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Stories</h2>
                    <button class="modal-close" onclick="closeStoryModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <!-- –ü—Ä–µ–≤—å—é –≥–æ—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
                    <div style="display:flex;justify-content:center;margin:16px 0;">
                        <canvas id="storyCanvas" width="720" height="1280" style="border-radius:16px;max-width:100%;height:auto;max-height:400px;box-shadow: 0 8px 32px rgba(0,0,0,0.3);"></canvas>
                    </div>
                    
                    <p style="text-align:center;color:var(--text-secondary);font-size:14px;margin-bottom:16px;">
                        –ö–∞—Ä—Ç–∏–Ω–∫–∞ + –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç¬ª
                    </p>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="shareStoryToTelegram()" style="width: 100%;">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ Stories</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Modal -->
        <div class="modal" id="privacyModal">
            <div class="modal-overlay" onclick="closePrivacyModal()"></div>
            <div class="modal-content" style="max-height: 55vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üîí –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h2>
                    <button class="modal-close" onclick="closePrivacyModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="list">
                        <div class="list-item privacy-option" data-value="public">
                            <div class="list-icon blue">üåç</div>
                            <div class="list-content">
                                <div class="list-title">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                                <div class="list-subtitle">–õ—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å</div>
                            </div>
                            <span class="privacy-check" id="check-public">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="friends">
                            <div class="list-icon green">üë•</div>
                            <div class="list-content">
                                <div class="list-title">–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</div>
                                <div class="list-subtitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram</div>
                            </div>
                            <span class="privacy-check" id="check-friends" style="display:none;">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="private">
                            <div class="list-icon purple">üîê</div>
                            <div class="list-content">
                                <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>
                                <div class="list-subtitle">–¢–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ</div>
                            </div>
                            <span class="privacy-check" id="check-private" style="display:none;">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verify Request Modal -->
        <div class="modal" id="verifyRequestModal">
            <div class="modal-overlay" onclick="closeVerifyRequestModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>‚úì –ó–∞–ø—Ä–æ—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</h2>
                    <button class="modal-close" onclick="closeVerifyRequestModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤–∞—à—É –ª–∏—á–Ω–æ—Å—Ç—å. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∑–∞—è–≤–∫—É.
                    </p>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞</label>
                        <textarea id="verifyReason" class="form-input" rows="3" placeholder="–ü–æ—á–µ–º—É –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –≥–∞–ª–æ—á–∫—É?"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="text" id="verifySocials" class="form-input" placeholder="Instagram, YouTube –∏ —Ç.–¥.">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeVerifyRequestModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="submitVerifyRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const ADMIN_ID = '7086128174';
        
        const state = {
            userId: tg?.initDataUnsafe?.user?.id?.toString() || 'demo',
            userName: tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: tg?.initDataUnsafe?.user?.username || 'user',
            photoUrl: tg?.initDataUnsafe?.user?.photo_url || null,
            privacy: localStorage.getItem('privacy') || 'public'
        };

        const haptic = {
            light: () => tg?.HapticFeedback?.impactOccurred('light'),
            success: () => tg?.HapticFeedback?.notificationOccurred('success')
        };

        function init() {
            loadProfile();
            loadStats();
            checkVerified();
            checkAdmin();
            checkAchievements();
            setupEvents();
            updatePrivacyStatus();
            checkVerifyRequestStatus();
        }

        function loadProfile() {
            document.getElementById('profileName').textContent = state.userName;
            document.getElementById('profileUsername').textContent = `@${state.username}`;
            
            if (state.photoUrl) {
                document.getElementById('avatarEmoji').style.display = 'none';
                const img = document.createElement('img');
                img.src = state.photoUrl;
                document.getElementById('profileAvatar').appendChild(img);
            }
        }

        function loadStats() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            animateValue('wishesCount', 0, wishes.length, 600);
            animateValue('giftedCount', 0, gifted, 600);
            animateValue('santaCount', 0, groups.length, 600);
        }

        function animateValue(id, start, end, duration) {
            const el = document.getElementById(id);
            if (!el) return;
            if (start === end) { el.textContent = end; return; }
            
            const startTime = performance.now();
            const range = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(start + range * eased);
                if (progress < 1) requestAnimationFrame(update);
            }
            
            requestAnimationFrame(update);
        }

        async function checkVerified() {
            const sb = window.supabaseClient;
            let isVerified = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ Supabase
            if (sb && state.userId !== 'demo') {
                try {
                    const { data: user } = await sb
                        .from('users')
                        .select('verified')
                        .eq('telegram_id', parseInt(state.userId))
                        .single();
                    
                    if (user && user.verified) {
                        isVerified = true;
                    }
                } catch (err) {
                    console.error('Check verified error:', err);
                }
            }
            
            document.getElementById('verifiedBadge').style.display = isVerified ? 'inline-flex' : 'none';
        }

        function checkAdmin() {
            // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω —á–µ—Ä–µ–∑ Telegram
            const isAdmin = tg && tg.initDataUnsafe?.user && state.userId === ADMIN_ID;
            document.getElementById('adminSection').style.display = isAdmin ? 'block' : 'none';
        }

        function checkAchievements() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            if (wishes.length > 0) document.getElementById('ach1').classList.remove('locked');
            if (groups.length > 0) document.getElementById('ach2').classList.remove('locked');
            if (gifted > 0) document.getElementById('ach3').classList.remove('locked');
            if (wishes.length >= 10) document.getElementById('ach4').classList.remove('locked');
            
            const created = groups.filter(g => g.adminId === state.userId);
            if (created.length > 0) document.getElementById('ach5').classList.remove('locked');
        }

        function setupEvents() {
            document.getElementById('menuShare').onclick = () => {
                haptic.light();
                shareProfile();
            };
            
            document.getElementById('menuStory').onclick = () => {
                haptic.light();
                openStoryEditor();
            };
            
            document.getElementById('menuChat').onclick = () => {
                haptic.light();
                if (tg) tg.openTelegramLink('https://t.me/giftly_chat');
                else window.open('https://t.me/giftly_chat', '_blank');
            };
            
            document.getElementById('menuPrivacy').onclick = () => {
                haptic.light();
                openPrivacyModal();
            };
            
            document.getElementById('menuSupport').onclick = () => {
                haptic.light();
                if (tg) tg.openTelegramLink('https://t.me/pravy_ru');
                else window.open('https://t.me/pravy_ru', '_blank');
            };
            
            document.getElementById('menuVerify').onclick = () => {
                haptic.light();
                openVerifyRequestModal();
            };
            
            // Achievement clicks
            document.querySelectorAll('.achievement').forEach(ach => {
                ach.onclick = () => {
                    haptic.light();
                    const name = ach.querySelector('.achievement-name').textContent;
                    const isLocked = ach.classList.contains('locked');
                    showToast(isLocked ? `üîí ${name} - –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ` : `‚úÖ ${name}`);
                };
            });

            // Privacy options
            document.querySelectorAll('.privacy-option').forEach(opt => {
                opt.onclick = () => {
                    const value = opt.dataset.value;
                    setPrivacy(value);
                };
            });
        }
        
        function shareProfile() {
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏—à–ª–∏—Å—Ç–∞
            const botUsername = window.BOT_USERNAME || 'giftly_wishlist_bot';
            const botUrl = `https://t.me/${botUsername}?start=wishlist_${state.userId}`;
            const text = 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!';
            
            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(botUrl)}&text=${encodeURIComponent(text)}`);
            } else if (navigator.share) {
                navigator.share({ title: 'Giftly', text, url: botUrl });
            } else {
                navigator.clipboard.writeText(botUrl);
                showToast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
            }
        }

        function openPrivacyModal() {
            updatePrivacyChecks();
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function setPrivacy(value) {
            state.privacy = value;
            localStorage.setItem('privacy', value);
            updatePrivacyChecks();
            updatePrivacyStatus();
            haptic.success();
            showToast('‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            closePrivacyModal();
        }

        function updatePrivacyChecks() {
            document.getElementById('check-public').style.display = state.privacy === 'public' ? 'inline' : 'none';
            document.getElementById('check-friends').style.display = state.privacy === 'friends' ? 'inline' : 'none';
            document.getElementById('check-private').style.display = state.privacy === 'private' ? 'inline' : 'none';
        }

        function updatePrivacyStatus() {
            const labels = { public: '–ü—É–±–ª–∏—á–Ω—ã–π', friends: '–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è', private: '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' };
            document.getElementById('privacyStatus').textContent = labels[state.privacy] || '–ü—É–±–ª–∏—á–Ω—ã–π';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2000);
        }

        // ===== VERIFY REQUEST =====
        function openVerifyRequestModal() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            const myRequest = requests.find(r => r.userId === state.userId);
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            const isVerified = verified.some(u => u.id === state.userId);
            
            if (isVerified) {
                showToast('‚úì –í—ã —É–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã!');
                return;
            }
            
            if (myRequest && myRequest.status === 'pending') {
                showToast('‚è≥ –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏');
                return;
            }
            
            document.getElementById('verifyRequestModal').classList.add('active');
        }
        
        function closeVerifyRequestModal() {
            document.getElementById('verifyRequestModal').classList.remove('active');
        }
        
        async function submitVerifyRequest() {
            const reason = document.getElementById('verifyReason').value.trim();
            const socials = document.getElementById('verifySocials').value.trim();
            
            if (!reason) {
                showToast('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É');
                return;
            }
            
            const sb = window.supabaseClient;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
            if (sb) {
                try {
                    const { error } = await sb
                        .from('verify_requests')
                        .insert([{
                            telegram_id: parseInt(state.userId),
                            user_name: state.userName,
                            username: state.username,
                            photo_url: state.photoUrl,
                            reason: reason,
                            socials: socials,
                            status: 'pending'
                        }]);
                    
                    if (error) {
                        console.error('Supabase error:', error);
                        // Fallback –Ω–∞ localStorage
                        saveRequestToLocal(reason, socials);
                    } else {
                        document.getElementById('verifyStatus').textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚è≥';
                        haptic.success();
                        showToast('‚úì –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                    }
                } catch (err) {
                    console.error('Error:', err);
                    saveRequestToLocal(reason, socials);
                }
            } else {
                saveRequestToLocal(reason, socials);
            }
            
            closeVerifyRequestModal();
            document.getElementById('verifyReason').value = '';
            document.getElementById('verifySocials').value = '';
        }
        
        function saveRequestToLocal(reason, socials) {
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            requests.push({
                id: Date.now().toString(),
                oderId: state.userId,
                userName: state.userName,
                username: state.username,
                photoUrl: state.photoUrl,
                reason: reason,
                socials: socials,
                status: 'pending',
                createdAt: Date.now()
            });
            localStorage.setItem('verifyRequests', JSON.stringify(requests));
            document.getElementById('verifyStatus').textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚è≥';
            haptic.success();
            showToast('‚úì –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        }
        
        async function checkVerifyRequestStatus() {
            const statusEl = document.getElementById('verifyStatus');
            const sb = window.supabaseClient;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ Supabase
            if (sb && state.userId !== 'demo') {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const { data: user } = await sb
                        .from('users')
                        .select('verified')
                        .eq('telegram_id', parseInt(state.userId))
                        .single();
                    
                    if (user && user.verified) {
                        statusEl.textContent = '–í—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã ‚úì';
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
                    const { data: request } = await sb
                        .from('verify_requests')
                        .select('status')
                        .eq('telegram_id', parseInt(state.userId))
                        .order('created_at', { ascending: false })
                        .limit(1)
                        .single();
                    
                    if (request) {
                        if (request.status === 'pending') {
                            statusEl.textContent = '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏ ‚è≥';
                        } else if (request.status === 'rejected') {
                            statusEl.textContent = '–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ ‚ùå';
                        } else if (request.status === 'approved') {
                            statusEl.textContent = '–í—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã ‚úì';
                        }
                    }
                } catch (err) {
                    console.error('Check verify status error:', err);
                }
            }
        }

        // ===== STORY EDITOR =====
        function openStoryEditor() {
            document.getElementById('storyModal').classList.add('active');
            updateStoryCanvas();
        }
        
        function closeStoryModal() {
            document.getElementById('storyModal').classList.remove('active');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –æ–¥–∏–Ω —Ä–∞–∑
        const storyBgImage = new Image();
        storyBgImage.src = 'story-image.png';
        
        function updateStoryCanvas() {
            const canvas = document.getElementById('storyCanvas');
            const ctx = canvas.getContext('2d');
            const w = 720, h = 1280;
            
            ctx.clearRect(0, 0, w, h);
            
            // –ü—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º –≥–æ—Ç–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –ë–ï–ó —Ç–µ–∫—Å—Ç–∞
            if (storyBgImage.complete) {
                ctx.drawImage(storyBgImage, 0, 0, w, h);
            } else {
                storyBgImage.onload = () => {
                    ctx.drawImage(storyBgImage, 0, 0, w, h);
                };
            }
        }
        
        async function shareStoryToTelegram() {
            if (!tg) {
                showToast('–û—Ç–∫—Ä–æ–π –≤ Telegram');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏—à–ª–∏—Å—Ç
            const botUsername = window.BOT_USERNAME || 'giftl_robot';
            const wishlistUrl = `https://t.me/${botUsername}?start=wishlist_${state.userId}`;
            
            // URL –≥–æ—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
            const storyImageUrl = `${window.location.origin}${window.location.pathname.replace('profile.html', '')}story-image.png`;
            
            console.log('shareToStory available:', !!tg.shareToStory);
            console.log('Story image URL:', storyImageUrl);
            console.log('Wishlist URL:', wishlistUrl);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram shareToStory API
            if (typeof tg.shareToStory === 'function') {
                haptic.success();
                try {
                    tg.shareToStory(storyImageUrl, {
                        widget_link: {
                            url: wishlistUrl,
                            name: '–û—Ç–∫—Ä—ã—Ç—å –≤–∏—à–ª–∏—Å—Ç'
                        }
                    });
                    closeStoryModal();
                    showToast('üì§ –û—Ç–∫—Ä—ã–≤–∞–µ–º Stories...');
                } catch (err) {
                    console.error('shareToStory error:', err);
                    showToast('–û—à–∏–±–∫–∞: ' + err.message);
                }
            } else {
                // Fallback - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à–µ—Ä–∏–Ω–≥ —Å—Å—ã–ª–∫–∏
                showToast('‚ö†Ô∏è Stories –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ Telegram');
                setTimeout(() => {
                    const text = 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!';
                    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(wishlistUrl)}&text=${encodeURIComponent(text)}`);
                }, 1000);
            }
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–µ–±-–≤–µ—Ä—Å–∏–∏
        if (!tg || !tg.initDataUnsafe?.user) {
            document.getElementById('webBlock').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
        } else {
            document.getElementById('webBlock').style.display = 'none';
        }
        
        init();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä openStory –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('openStory') === '1') {
            // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
            window.history.replaceState({}, '', window.location.pathname);
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä Stories —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => openStoryEditor(), 300);
        }
    </script>

    <style>
        .privacy-check { color: #667eea; font-weight: bold; }
    </style>
</body>
</html>
