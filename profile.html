<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly - –ü—Ä–æ—Ñ–∏–ª—å</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app">
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üéÅ</span>
                <span class="nav-label">–ñ–µ–ª–∞–Ω–∏—è</span>
            </a>
            <a href="santa.html" class="nav-item">
                <span class="nav-icon">üéÖ</span>
                <span class="nav-label">–°–∞–Ω—Ç–∞</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
        </nav>

        <header class="profile-header">
            <div class="garland">
                <div class="garland-wire"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
                <div class="garland-light"></div>
            </div>
            <div class="profile-avatar" id="profileAvatar">
                <span id="avatarEmoji">üêª‚Äç‚ùÑÔ∏è</span>
            </div>
            <h1 class="profile-name">
                <span id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <span class="verified-badge" id="verifiedBadge" style="display: none;">‚úì</span>
            </h1>
            <p class="profile-username" id="profileUsername">@username</p>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-value" id="wishesCount">0</div>
                    <div class="stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="giftedCount">0</div>
                    <div class="stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="santaCount">0</div>
                    <div class="stat-label">–ì—Ä—É–ø–ø</div>
                </div>
            </div>
        </header>

        <div class="section" style="margin-top: 24px;">
            <div class="section-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div class="achievements-grid">
                <div class="achievement locked" id="ach1"><div class="achievement-icon">üéÅ</div><div class="achievement-name">–ü–µ—Ä–≤–æ–µ</div></div>
                <div class="achievement locked" id="ach2"><div class="achievement-icon">üéÖ</div><div class="achievement-name">–°–∞–Ω—Ç–∞</div></div>
                <div class="achievement locked" id="ach3"><div class="achievement-icon">üíù</div><div class="achievement-name">–©–µ–¥—Ä—ã–π</div></div>
                <div class="achievement locked" id="ach4"><div class="achievement-icon">‚≠ê</div><div class="achievement-name">10+</div></div>
                <div class="achievement locked" id="ach5"><div class="achievement-icon">üéÑ</div><div class="achievement-name">–õ–∏–¥–µ—Ä</div></div>
                <div class="achievement locked" id="ach6"><div class="achievement-icon">üåü</div><div class="achievement-name">–ó–≤–µ–∑–¥–∞</div></div>
                <div class="achievement locked" id="ach7"><div class="achievement-icon">üíé</div><div class="achievement-name">VIP</div></div>
                <div class="achievement locked" id="ach8"><div class="achievement-icon">üèÜ</div><div class="achievement-name">–õ–µ–≥–µ–Ω–¥–∞</div></div>
            </div>
        </div>

        <div class="section">
            <div class="section-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="list">
                <div class="list-item" id="menuShare">
                    <div class="list-icon blue">üì§</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
                        <div class="list-subtitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏—à–ª–∏—Å—Ç –¥—Ä—É–∑—å—è–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuPrivacy">
                    <div class="list-icon purple">üîí</div>
                    <div class="list-content">
                        <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>
                        <div class="list-subtitle" id="privacyStatus">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
                <div class="list-item" id="menuSupport">
                    <div class="list-icon green">üí¨</div>
                    <div class="list-content">
                        <div class="list-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                        <div class="list-subtitle">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <!-- Admin Link (only for admin) -->
        <div class="section" id="adminSection" style="display: none;">
            <div class="section-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            <div class="list">
                <div class="list-item" onclick="location.href='admin.html'">
                    <div class="list-icon red">‚öôÔ∏è</div>
                    <div class="list-content">
                        <div class="list-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                        <div class="list-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</div>
                    </div>
                    <span class="list-arrow">‚Ä∫</span>
                </div>
            </div>
        </div>

        <p style="text-align: center; color: var(--text-tertiary); font-size: 13px; padding: 20px;">
            <span class="mascot mascot-small">üêª‚Äç‚ùÑÔ∏è</span> Giftly v1.0
        </p>

        <!-- Privacy Modal -->
        <div class="modal" id="privacyModal">
            <div class="modal-overlay" onclick="closePrivacyModal()"></div>
            <div class="modal-content" style="max-height: 55vh;">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üîí –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h2>
                    <button class="modal-close" onclick="closePrivacyModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="list">
                        <div class="list-item privacy-option" data-value="public">
                            <div class="list-icon blue">üåç</div>
                            <div class="list-content">
                                <div class="list-title">–ü—É–±–ª–∏—á–Ω—ã–π</div>
                                <div class="list-subtitle">–õ—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å</div>
                            </div>
                            <span class="privacy-check" id="check-public">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="friends">
                            <div class="list-icon green">üë•</div>
                            <div class="list-content">
                                <div class="list-title">–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</div>
                                <div class="list-subtitle">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram</div>
                            </div>
                            <span class="privacy-check" id="check-friends" style="display:none;">‚úì</span>
                        </div>
                        <div class="list-item privacy-option" data-value="private">
                            <div class="list-icon purple">üîê</div>
                            <div class="list-content">
                                <div class="list-title">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</div>
                                <div class="list-subtitle">–¢–æ–ª—å–∫–æ –ø–æ —Å—Å—ã–ª–∫–µ</div>
                            </div>
                            <span class="privacy-check" id="check-private" style="display:none;">‚úì</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const ADMIN_ID = '7086128174';
        
        const state = {
            userId: tg?.initDataUnsafe?.user?.id?.toString() || 'demo',
            userName: tg?.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            username: tg?.initDataUnsafe?.user?.username || 'user',
            photoUrl: tg?.initDataUnsafe?.user?.photo_url || null,
            privacy: localStorage.getItem('privacy') || 'public'
        };

        const haptic = {
            light: () => tg?.HapticFeedback?.impactOccurred('light'),
            success: () => tg?.HapticFeedback?.notificationOccurred('success')
        };

        function init() {
            loadProfile();
            loadStats();
            checkVerified();
            checkAdmin();
            checkAchievements();
            setupEvents();
            updatePrivacyStatus();
        }

        function loadProfile() {
            document.getElementById('profileName').textContent = state.userName;
            document.getElementById('profileUsername').textContent = `@${state.username}`;
            
            if (state.photoUrl) {
                document.getElementById('avatarEmoji').style.display = 'none';
                const img = document.createElement('img');
                img.src = state.photoUrl;
                document.getElementById('profileAvatar').appendChild(img);
            }
        }

        function loadStats() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            animateValue('wishesCount', 0, wishes.length, 600);
            animateValue('giftedCount', 0, gifted, 600);
            animateValue('santaCount', 0, groups.length, 600);
        }

        function animateValue(id, start, end, duration) {
            const el = document.getElementById(id);
            if (!el) return;
            if (start === end) { el.textContent = end; return; }
            
            const startTime = performance.now();
            const range = end - start;
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(start + range * eased);
                if (progress < 1) requestAnimationFrame(update);
            }
            
            requestAnimationFrame(update);
        }

        function checkVerified() {
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            const isVerified = verified.some(u => u.id === state.userId);
            document.getElementById('verifiedBadge').style.display = isVerified ? 'inline-flex' : 'none';
        }

        function checkAdmin() {
            const isAdmin = state.userId === ADMIN_ID || state.userId === 'demo';
            document.getElementById('adminSection').style.display = isAdmin ? 'block' : 'none';
        }

        function checkAchievements() {
            const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
            const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
            const gifted = wishes.filter(w => w.reserved).length;
            
            if (wishes.length > 0) document.getElementById('ach1').classList.remove('locked');
            if (groups.length > 0) document.getElementById('ach2').classList.remove('locked');
            if (gifted > 0) document.getElementById('ach3').classList.remove('locked');
            if (wishes.length >= 10) document.getElementById('ach4').classList.remove('locked');
            
            const created = groups.filter(g => g.adminId === state.userId);
            if (created.length > 0) document.getElementById('ach5').classList.remove('locked');
        }

        function setupEvents() {
            document.getElementById('menuShare').onclick = () => {
                haptic.light();
                shareProfile();
            };
            
            document.getElementById('menuPrivacy').onclick = () => {
                haptic.light();
                openPrivacyModal();
            };
            
            document.getElementById('menuSupport').onclick = () => {
                haptic.light();
                if (tg) tg.openTelegramLink('https://t.me/giftly_support');
                else window.open('https://t.me/giftly_support', '_blank');
            };
            
            // Achievement clicks
            document.querySelectorAll('.achievement').forEach(ach => {
                ach.onclick = () => {
                    haptic.light();
                    const name = ach.querySelector('.achievement-name').textContent;
                    const isLocked = ach.classList.contains('locked');
                    showToast(isLocked ? `üîí ${name} - –µ—â—ë –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ` : `‚úÖ ${name}`);
                };
            });

            // Privacy options
            document.querySelectorAll('.privacy-option').forEach(opt => {
                opt.onclick = () => {
                    const value = opt.dataset.value;
                    setPrivacy(value);
                };
            });
        }

        function shareProfile() {
            const url = `${window.location.origin}${window.location.pathname.replace('profile.html', '')}shared.html?user=${state.userId}`;
            const text = 'üéÅ –ú–æ–π –≤–∏—à–ª–∏—Å—Ç –≤ Giftly!';
            
            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`);
            } else if (navigator.share) {
                navigator.share({ title: 'Giftly', text, url });
            } else {
                navigator.clipboard.writeText(url);
                showToast('‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
            }
        }

        function openPrivacyModal() {
            updatePrivacyChecks();
            document.getElementById('privacyModal').classList.add('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').classList.remove('active');
        }

        function setPrivacy(value) {
            state.privacy = value;
            localStorage.setItem('privacy', value);
            updatePrivacyChecks();
            updatePrivacyStatus();
            haptic.success();
            showToast('‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            closePrivacyModal();
        }

        function updatePrivacyChecks() {
            document.getElementById('check-public').style.display = state.privacy === 'public' ? 'inline' : 'none';
            document.getElementById('check-friends').style.display = state.privacy === 'friends' ? 'inline' : 'none';
            document.getElementById('check-private').style.display = state.privacy === 'private' ? 'inline' : 'none';
        }

        function updatePrivacyStatus() {
            const labels = { public: '–ü—É–±–ª–∏—á–Ω—ã–π', friends: '–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è', private: '–ü—Ä–∏–≤–∞—Ç–Ω—ã–π' };
            document.getElementById('privacyStatus').textContent = labels[state.privacy] || '–ü—É–±–ª–∏—á–Ω—ã–π';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2000);
        }

        init();
    </script>

    <script src="config.js"></script>
    <style>
        .privacy-check { color: #667eea; font-weight: bold; }
    </style>
</body>
</html>
