<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app">
        <!-- Access Denied -->
        <div id="accessDenied" style="display: none;">
            <div class="empty-state active">
                <div class="empty-icon">üîí</div>
                <h3>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h3>
                <p>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <header class="header">
                <div class="header-content">
                    <h1>Admin</h1>
                    <div class="header-actions">
                        <button class="btn-icon" onclick="location.href='index.html'">üè†</button>
                    </div>
                </div>
            </header>

            <!-- Stats -->
            <div class="section">
                <div class="section-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="admin-grid">
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalUsers">0</div>
                        <div class="admin-stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalWishes">0</div>
                        <div class="admin-stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalGroups">0</div>
                        <div class="admin-stat-label">–ì—Ä—É–ø–ø –°–∞–Ω—Ç—ã</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalGifted">0</div>
                        <div class="admin-stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="section">
                <div class="section-header">‚ö° –î–µ–π—Å—Ç–≤–∏—è</div>
                <div class="list">
                    <div class="list-item" onclick="openBroadcastModal()">
                        <div class="list-icon blue">üì¢</div>
                        <div class="list-content">
                            <div class="list-title">–†–∞—Å—Å—ã–ª–∫–∞</div>
                            <div class="list-subtitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="openVerifyModal()">
                        <div class="list-icon green">‚úì</div>
                        <div class="list-content">
                            <div class="list-title">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
                            <div class="list-subtitle">–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="exportData()">
                        <div class="list-icon orange">üì•</div>
                        <div class="list-content">
                            <div class="list-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                            <div class="list-subtitle">–°–∫–∞—á–∞—Ç—å JSON</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="clearAllData()">
                        <div class="list-icon red">üóëÔ∏è</div>
                        <div class="list-content">
                            <div class="list-title">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                            <div class="list-subtitle">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                </div>
            </div>

            <!-- Verify Requests -->
            <div class="section">
                <div class="section-header">üìù –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é <span id="requestsCount" style="background: #c41e3a; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">0</span></div>
                <div id="verifyRequestsList" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –∑–∞—è–≤–æ–∫
                    </div>
                </div>
            </div>

            <!-- Verified Users -->
            <div class="section">
                <div class="section-header">‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</div>
                <div id="verifiedList" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section">
                <div class="section-header">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                <div id="activityLog" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Modal -->
        <div class="modal" id="broadcastModal">
            <div class="modal-overlay" onclick="closeBroadcastModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h2>
                    <button class="modal-close" onclick="closeBroadcastModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea id="broadcastMessage" class="form-input" rows="4" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="photo-upload" onclick="document.getElementById('broadcastPhoto').click()">
                            <input type="file" id="broadcastPhoto" accept="image/*" hidden onchange="handleBroadcastPhoto(this)">
                            <div class="photo-preview" id="broadcastPhotoPreview">
                                <span class="upload-icon">üì∑</span>
                                <span class="upload-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeBroadcastModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="sendBroadcast()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verify Modal -->
        <div class="modal" id="verifyModal">
            <div class="modal-overlay" onclick="closeVerifyModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>‚úì –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
                    <button class="modal-close" onclick="closeVerifyModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Telegram ID</label>
                        <input type="text" id="verifyUserId" class="form-input" placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="verifyUserName" class="form-input" placeholder="–ò–º—è">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeVerifyModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="verifyUser()">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const ADMIN_ID = '7086128174';
        const currentUserId = tg?.initDataUnsafe?.user?.id?.toString();
        
        // Supabase –∫–ª–∏–µ–Ω—Ç
        const supabase = window.supabase?.createClient(
            'https://vmyzknraixtqvsceaujd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXprbnJhaXh0cXZzY2VhdWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODU0NzAsImV4cCI6MjA4MDc2MTQ3MH0.ame1hcZVX__x3WqREK18LJiAM9CuuQdS8FnbKIWMH1c'
        );

        // Check admin access
        function checkAccess() {
            const isTelegram = tg && tg.initDataUnsafe?.user;
            const isAdmin = isTelegram && currentUserId === ADMIN_ID;
            
            if (!isTelegram) {
                document.body.innerHTML = `
                    <div style="position: fixed; inset: 0; background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%); display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 40px; text-align: center;">
                        <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
                        <h1 style="color: #1b5e20; font-size: 28px; margin-bottom: 16px;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h1>
                        <p style="color: #388e3c; font-size: 16px; margin-bottom: 32px;">
                            –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram
                        </p>
                        <a href="https://t.me/giftl_robot" style="background: #34c759; color: white; padding: 16px 32px; border-radius: 12px; text-decoration: none; font-weight: 600;">
                            üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                        </a>
                    </div>
                `;
                return;
            }
            
            document.getElementById('accessDenied').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
            
            if (isAdmin) {
                loadStats();
                loadVerifyRequests();
                loadVerifiedUsers();
                loadActivity();
                
                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                subscribeToRealtime();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ Supabase
        async function loadStats() {
            try {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                const { data: users, error: usersErr } = await supabase
                    .from('users')
                    .select('id', { count: 'exact' });
                
                // –ñ–µ–ª–∞–Ω–∏—è
                const { data: wishes, error: wishesErr } = await supabase
                    .from('wishes')
                    .select('id, reserved', { count: 'exact' });
                
                // –ì—Ä—É–ø–ø—ã –°–∞–Ω—Ç—ã
                const { data: groups, error: groupsErr } = await supabase
                    .from('santa_groups')
                    .select('id', { count: 'exact' });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('totalWishes').textContent = wishes?.length || 0;
                document.getElementById('totalGroups').textContent = groups?.length || 0;
                document.getElementById('totalGifted').textContent = wishes?.filter(w => w.reserved)?.length || 0;
                
            } catch (err) {
                console.error('Stats error:', err);
                // Fallback –Ω–∞ localStorage
                const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
                const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
                document.getElementById('totalWishes').textContent = wishes.length;
                document.getElementById('totalGroups').textContent = groups.length;
            }
        }
        
        // Realtime –ø–æ–¥–ø–∏—Å–∫–∞
        function subscribeToRealtime() {
            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            supabase
                .channel('admin-stats')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => loadStats())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'wishes' }, () => loadStats())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'santa_groups' }, () => loadStats())
                .subscribe();
        }

        async function loadVerifyRequests() {
            const list = document.getElementById('verifyRequestsList');
            let pending = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
            if (supabase) {
                try {
                    const { data, error } = await supabase
                        .from('verify_requests')
                        .select('*')
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false });
                    
                    if (data && !error) {
                        pending = data.map(r => ({
                            id: r.id,
                            oderId: r.telegram_id?.toString(),
                            userName: r.user_name,
                            username: r.username,
                            photoUrl: r.photo_url,
                            reason: r.reason,
                            socials: r.socials
                        }));
                    }
                } catch (err) {
                    console.error('Load requests error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            if (pending.length === 0) {
                const localRequests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
                pending = localRequests.filter(r => r.status === 'pending');
            }
            
            document.getElementById('requestsCount').textContent = pending.length;
            
            if (pending.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
                return;
            }
            
            list.innerHTML = pending.map(r => `
                <div class="list-item" style="flex-wrap: wrap; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 200px;">
                        <div class="list-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            ${r.photoUrl ? `<img src="${r.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : 'üë§'}
                        </div>
                        <div class="list-content">
                            <div class="list-title">${r.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${r.username ? '(@' + r.username + ')' : ''}</div>
                            <div class="list-subtitle">ID: ${r.userId || r.id}</div>
                            <div class="list-subtitle" style="margin-top: 4px; color: var(--text-primary);">"${r.reason}"</div>
                            ${r.socials ? `<div class="list-subtitle">üîó ${r.socials}</div>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-success" onclick="approveRequest('${r.id}')" style="padding: 8px 16px;">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="btn btn-danger" onclick="rejectRequest('${r.id}')" style="padding: 8px 16px;">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function approveRequest(requestId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É
                    const { data: request } = await supabase
                        .from('verify_requests')
                        .select('*')
                        .eq('id', requestId)
                        .single();
                    
                    if (request) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
                        await supabase
                            .from('verify_requests')
                            .update({ status: 'approved' })
                            .eq('id', requestId);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ verified –≤ —Ç–∞–±–ª–∏—Ü–µ users
                        await supabase
                            .from('users')
                            .update({ verified: true })
                            .eq('telegram_id', request.telegram_id);
                        
                        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
                        const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
                        verified.push({
                            id: request.telegram_id?.toString(),
                            name: request.user_name,
                            username: request.username,
                            verifiedAt: Date.now()
                        });
                        localStorage.setItem('verifiedUsers', JSON.stringify(verified));
                        
                        logActivity('verify', `–û–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.user_name}`);
                        showToast('‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞');
                        loadVerifyRequests();
                        loadVerifiedUsers();
                        return;
                    }
                } catch (err) {
                    console.error('Approve error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === parseInt(requestId));
            
            if (request) {
                const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
                verified.push({
                    id: request.userId,
                    name: request.userName,
                    username: request.username,
                    verifiedAt: Date.now()
                });
                localStorage.setItem('verifiedUsers', JSON.stringify(verified));
                request.status = 'approved';
                localStorage.setItem('verifyRequests', JSON.stringify(requests));
                logActivity('verify', `–û–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.userName}`);
                showToast('‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞');
                loadVerifyRequests();
                loadVerifiedUsers();
            }
        }
        
        async function rejectRequest(requestId) {
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    const { data: request } = await supabase
                        .from('verify_requests')
                        .select('user_name')
                        .eq('id', requestId)
                        .single();
                    
                    await supabase
                        .from('verify_requests')
                        .update({ status: 'rejected' })
                        .eq('id', requestId);
                    
                    logActivity('verify', `–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request?.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`);
                    showToast('‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                    loadVerifyRequests();
                    return;
                } catch (err) {
                    console.error('Reject error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === parseInt(requestId));
            if (request) {
                request.status = 'rejected';
                localStorage.setItem('verifyRequests', JSON.stringify(requests));
                logActivity('verify', `–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.userName}`);
                showToast('‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                loadVerifyRequests();
            }
        }

        function loadVerifiedUsers() {
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            const list = document.getElementById('verifiedList');
            
            if (verified.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            list.innerHTML = verified.map(u => `
                <div class="list-item">
                    <div class="list-icon green">‚úì</div>
                    <div class="list-content">
                        <div class="list-title">${u.name} ${u.username ? '(@' + u.username + ')' : ''}</div>
                        <div class="list-subtitle">ID: ${u.id}</div>
                    </div>
                    <button class="btn btn-text" onclick="removeVerification('${u.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function loadActivity() {
            const activity = JSON.parse(localStorage.getItem('adminActivity') || '[]');
            const list = document.getElementById('activityLog');
            
            if (activity.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
                return;
            }
            
            list.innerHTML = activity.slice(0, 10).map(a => `
                <div class="list-item">
                    <div class="list-icon ${a.type === 'broadcast' ? 'blue' : 'green'}">${a.type === 'broadcast' ? 'üì¢' : '‚úì'}</div>
                    <div class="list-content">
                        <div class="list-title">${a.action}</div>
                        <div class="list-subtitle">${new Date(a.time).toLocaleString('ru')}</div>
                    </div>
                </div>
            `).join('');
        }

        function logActivity(type, action) {
            const activity = JSON.parse(localStorage.getItem('adminActivity') || '[]');
            activity.unshift({ type, action, time: Date.now() });
            localStorage.setItem('adminActivity', JSON.stringify(activity.slice(0, 50)));
            loadActivity();
        }

        // Broadcast
        let broadcastPhotoData = null;
        
        function openBroadcastModal() { 
            document.getElementById('broadcastModal').classList.add('active'); 
            broadcastPhotoData = null;
            document.getElementById('broadcastPhotoPreview').style.backgroundImage = '';
            document.getElementById('broadcastPhotoPreview').classList.remove('has-image');
        }
        function closeBroadcastModal() { document.getElementById('broadcastModal').classList.remove('active'); }

        function handleBroadcastPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast('–ú–∞–∫—Å. 5MB'); return; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                broadcastPhotoData = e.target.result;
                const preview = document.getElementById('broadcastPhotoPreview');
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'); return; }
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –±–æ—Ç–∞
            const command = `/broadcast ${message}`;
            
            try {
                await navigator.clipboard.writeText(command);
                showToast('üìã –ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                setTimeout(() => {
                    alert(
                        'üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:\n\n' +
                        '1. –ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä\n' +
                        '2. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ @giftl_robot\n' +
                        '3. –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ\n\n' +
                        '–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ñ–æ—Ç–æ - –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π /broadcast'
                    );
                }, 500);
                
            } catch (err) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
                alert(`–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:\n\n${command}`);
            }
            
            logActivity('broadcast', `–†–∞—Å—Å—ã–ª–∫–∞: "${message.substring(0, 30)}${message.length > 30 ? '...' : ''}"`);
            closeBroadcastModal();
            document.getElementById('broadcastMessage').value = '';
            broadcastPhotoData = null;
        }

        // Verify
        function openVerifyModal() { document.getElementById('verifyModal').classList.add('active'); }
        function closeVerifyModal() { document.getElementById('verifyModal').classList.remove('active'); }

        async function verifyUser() {
            const userId = document.getElementById('verifyUserId').value.trim();
            const userName = document.getElementById('verifyUserName').value.trim();
            
            if (!userId || !userName) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
            
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            
            if (verified.some(u => u.id === userId)) {
                showToast('–£–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({ verified: true })
                        .eq('telegram_id', parseInt(userId));
                } catch (err) {
                    console.error('Verify user error:', err);
                }
            }
            
            verified.push({ id: userId, name: userName, verifiedAt: Date.now() });
            localStorage.setItem('verifiedUsers', JSON.stringify(verified));
            
            logActivity('verify', `–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: ${userName}`);
            showToast('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            closeVerifyModal();
            loadVerifiedUsers();
            loadStats();
            
            document.getElementById('verifyUserId').value = '';
            document.getElementById('verifyUserName').value = '';
        }

        function removeVerification(userId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é?')) return;
            
            let verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            verified = verified.filter(u => u.id !== userId);
            localStorage.setItem('verifiedUsers', JSON.stringify(verified));
            
            logActivity('verify', '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
            showToast('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
            loadVerifiedUsers();
            loadStats();
        }

        function exportData() {
            const data = {
                wishes: JSON.parse(localStorage.getItem('wishes') || '[]'),
                groups: JSON.parse(localStorage.getItem('santaGroups') || '[]'),
                verified: JSON.parse(localStorage.getItem('verifiedUsers') || '[]'),
                activity: JSON.parse(localStorage.getItem('adminActivity') || '[]'),
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `giftly-export-${Date.now()}.json`;
            a.click();
            
            showToast('üì• –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
        }

        function clearAllData() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
            
            localStorage.clear();
            showToast('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
            loadStats();
            loadVerifiedUsers();
            loadActivity();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        }

        checkAccess();
    </script>
    <script src="config.js"></script>
</body>
</html>
