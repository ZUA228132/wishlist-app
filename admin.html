<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Giftly Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
        <div class="ambient-orb"></div>
    </div>

    <div class="app">
        <!-- Access Denied -->
        <div id="accessDenied" style="display: none;">
            <div class="empty-state active">
                <div class="empty-icon">üîí</div>
                <h3>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h3>
                <p>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <header class="header">
                <div class="header-content">
                    <h1>Admin</h1>
                    <div class="header-actions">
                        <button class="btn-icon" onclick="location.href='index.html'">üè†</button>
                    </div>
                </div>
            </header>

            <!-- Stats -->
            <div class="section">
                <div class="section-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="admin-grid">
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalUsers">0</div>
                        <div class="admin-stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalWishes">0</div>
                        <div class="admin-stat-label">–ñ–µ–ª–∞–Ω–∏–π</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalGroups">0</div>
                        <div class="admin-stat-label">–ì—Ä—É–ø–ø –°–∞–Ω—Ç—ã</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-value" id="totalGifted">0</div>
                        <div class="admin-stat-label">–ü–æ–¥–∞—Ä–µ–Ω–æ</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="section">
                <div class="section-header">‚ö° –î–µ–π—Å—Ç–≤–∏—è</div>
                <div class="list">
                    <div class="list-item" onclick="openBroadcastModal()">
                        <div class="list-icon blue">üì¢</div>
                        <div class="list-content">
                            <div class="list-title">–†–∞—Å—Å—ã–ª–∫–∞</div>
                            <div class="list-subtitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="openVerifyModal()">
                        <div class="list-icon green">‚úì</div>
                        <div class="list-content">
                            <div class="list-title">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
                            <div class="list-subtitle">–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="exportData()">
                        <div class="list-icon orange">üì•</div>
                        <div class="list-content">
                            <div class="list-title">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                            <div class="list-subtitle">–°–∫–∞—á–∞—Ç—å JSON</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="clearAllData()">
                        <div class="list-icon red">üóëÔ∏è</div>
                        <div class="list-content">
                            <div class="list-title">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                            <div class="list-subtitle">–£–¥–∞–ª–∏—Ç—å –≤—Å—ë (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="section">
                <div class="section-header">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
                <div class="list">
                    <div class="list-item" onclick="openUserSearchModal()">
                        <div class="list-icon blue">üîç</div>
                        <div class="list-content">
                            <div class="list-title">–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                            <div class="list-subtitle">–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ username</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="openBlockUserModal()">
                        <div class="list-icon red">üö´</div>
                        <div class="list-content">
                            <div class="list-title">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>
                            <div class="list-subtitle">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                    <div class="list-item" onclick="loadBlockedUsers()">
                        <div class="list-icon orange">üìã</div>
                        <div class="list-content">
                            <div class="list-title">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</div>
                            <div class="list-subtitle">–°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                </div>
                <div id="blockedUsersList" class="list" style="margin-top: 10px; display: none;"></div>
            </div>

            <!-- Tasks Management -->
            <div class="section">
                <div class="section-header">üéüÔ∏è –ó–∞–¥–∞–Ω–∏—è –∑–∞ –±–∏–ª–µ—Ç–∏–∫–∏</div>
                <div class="list">
                    <div class="list-item" onclick="openTaskModal()">
                        <div class="list-icon gold">‚ûï</div>
                        <div class="list-content">
                            <div class="list-title">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</div>
                            <div class="list-subtitle">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                </div>
                <div id="tasksList" class="list" style="margin-top: 10px;"></div>
            </div>

            <!-- Raffles Management -->
            <div class="section">
                <div class="section-header">üéÅ –†–æ–∑—ã–≥—Ä—ã—à–∏</div>
                <div class="list">
                    <div class="list-item" onclick="openRaffleModal()">
                        <div class="list-icon purple">‚ûï</div>
                        <div class="list-content">
                            <div class="list-title">–°–æ–∑–¥–∞—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à</div>
                            <div class="list-subtitle">–ù–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à NFT/–ø–æ–¥–∞—Ä–∫–æ–≤</div>
                        </div>
                        <span class="list-arrow">‚Ä∫</span>
                    </div>
                </div>
                <div id="rafflesList" class="list" style="margin-top: 10px;"></div>
            </div>

            <!-- Verify Requests -->
            <div class="section">
                <div class="section-header">üìù –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é <span id="requestsCount" style="background: #c41e3a; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px;">0</span></div>
                <div id="verifyRequestsList" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –∑–∞—è–≤–æ–∫
                    </div>
                </div>
            </div>

            <!-- Verified Users -->
            <div class="section">
                <div class="section-header">‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</div>
                <div id="verifiedList" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section">
                <div class="section-header">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                <div id="activityLog" class="list">
                    <div class="list-item" style="justify-content: center; color: var(--text-secondary);">
                        –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </div>
                </div>
            </div>
        </div>

        <!-- Broadcast Modal -->
        <div class="modal" id="broadcastModal">
            <div class="modal-overlay" onclick="closeBroadcastModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üì¢ –†–∞—Å—Å—ã–ª–∫–∞</h2>
                    <button class="modal-close" onclick="closeBroadcastModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea id="broadcastMessage" class="form-input" rows="4" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="photo-upload" onclick="document.getElementById('broadcastPhoto').click()">
                            <input type="file" id="broadcastPhoto" accept="image/*" hidden onchange="handleBroadcastPhoto(this)">
                            <div class="photo-preview" id="broadcastPhotoPreview">
                                <span class="upload-icon">üì∑</span>
                                <span class="upload-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeBroadcastModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="sendBroadcast()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verify Modal -->
        <div class="modal" id="verifyModal">
            <div class="modal-overlay" onclick="closeVerifyModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>‚úì –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
                    <button class="modal-close" onclick="closeVerifyModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Telegram ID</label>
                        <input type="text" id="verifyUserId" class="form-input" placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" id="verifyUserName" class="form-input" placeholder="–ò–º—è">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeVerifyModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-success" onclick="verifyUser()">–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Modal -->
        <div class="modal" id="taskModal">
            <div class="modal-overlay" onclick="closeTaskModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üéüÔ∏è –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
                    <button class="modal-close" onclick="closeTaskModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è</label>
                        <select id="taskType" class="form-input">
                            <option value="subscribe">üì¢ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</option>
                            <option value="join_chat">üí¨ –í—Å—Ç—É–ø–∏—Ç—å –≤ —á–∞—Ç</option>
                            <option value="open_app">üì± –û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø</option>
                            <option value="daily">üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ</option>
                            <option value="referral">üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</option>
                            <option value="action">‚ö° –î–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" id="taskDesc" class="form-input" placeholder="–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à Telegram –∫–∞–Ω–∞–ª">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Å—ã–ª–∫–∞ / ID –∫–∞–Ω–∞–ª–∞</label>
                        <input type="text" id="taskLink" class="form-input" placeholder="https://t.me/channel –∏–ª–∏ @channel">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ù–∞–≥—Ä–∞–¥–∞ (–±–∏–ª–µ—Ç–∏–∫–æ–≤)</label>
                        <input type="number" id="taskReward" class="form-input" value="3" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏)</label>
                        <input type="text" id="taskIcon" class="form-input" value="üì¢" maxlength="4">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raffle Modal -->
        <div class="modal" id="raffleModal">
            <div class="modal-overlay" onclick="closeRaffleModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üéÅ –ù–æ–≤—ã–π —Ä–æ–∑—ã–≥—Ä—ã—à</h2>
                    <button class="modal-close" onclick="closeRaffleModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="raffleTitle" class="form-input" placeholder="–†–æ–∑—ã–≥—Ä—ã—à NFT –ø–æ–¥–∞—Ä–∫–∞">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–∑–∞</label>
                        <textarea id="raffleDesc" class="form-input" rows="3" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π NFT –ø–æ–¥–∞—Ä–æ–∫..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –ø—Ä–∏–∑–∞</label>
                        <select id="rafflePrizeType" class="form-input">
                            <option value="nft">üñºÔ∏è NFT</option>
                            <option value="gift">üéÅ –§–∏–∑–∏—á–µ—Å–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫</option>
                            <option value="premium">‚≠ê Telegram Premium</option>
                            <option value="money">üí∞ –î–µ–Ω–µ–∂–Ω—ã–π –ø—Ä–∏–∑</option>
                            <option value="other">üì¶ –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–∑–∞</label>
                        <input type="text" id="rafflePrizeValue" class="form-input" placeholder="1000 ‚ÇΩ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                        <input type="datetime-local" id="raffleEndDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ú–∏–Ω. –±–∏–ª–µ—Ç–∏–∫–æ–≤ –¥–ª—è —É—á–∞—Å—Ç–∏—è</label>
                        <input type="number" id="raffleMinTickets" class="form-input" value="1" min="1">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeRaffleModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-primary" onclick="saveRaffle()">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Search Modal -->
        <div class="modal" id="userSearchModal">
            <div class="modal-overlay" onclick="closeUserSearchModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                    <button class="modal-close" onclick="closeUserSearchModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Telegram ID –∏–ª–∏ @username</label>
                        <input type="text" id="userSearchQuery" class="form-input" placeholder="123456789 –∏–ª–∏ @username">
                    </div>
                    <button class="btn btn-primary btn-large" onclick="searchUser()">–ù–∞–π—Ç–∏</button>
                    <div id="userSearchResult" style="margin-top: 16px;"></div>
                </div>
            </div>
        </div>

        <!-- Block User Modal -->
        <div class="modal" id="blockUserModal">
            <div class="modal-overlay" onclick="closeBlockUserModal()"></div>
            <div class="modal-content">
                <div class="modal-handle"></div>
                <div class="modal-header">
                    <h2>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</h2>
                    <button class="modal-close" onclick="closeBlockUserModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Telegram ID</label>
                        <input type="text" id="blockUserId" class="form-input" placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</label>
                        <textarea id="blockReason" class="form-input" rows="2" placeholder="–°–ø–∞–º, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—Ä–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</label>
                        <select id="blockDuration" class="form-input">
                            <option value="forever">–ù–∞–≤—Å–µ–≥–¥–∞</option>
                            <option value="1d">1 –¥–µ–Ω—å</option>
                            <option value="7d">7 –¥–Ω–µ–π</option>
                            <option value="30d">30 –¥–Ω–µ–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="restrictWishes"> –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∂–µ–ª–∞–Ω–∏–π
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="restrictSanta"> –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –°–∞–Ω—Ç–µ
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="restrictRaffles"> –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="closeBlockUserModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn btn-danger" onclick="blockUser()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }
        
        const haptic = {
            light: () => tg?.HapticFeedback?.impactOccurred('light'),
            medium: () => tg?.HapticFeedback?.impactOccurred('medium'),
            success: () => tg?.HapticFeedback?.notificationOccurred('success'),
            error: () => tg?.HapticFeedback?.notificationOccurred('error'),
            selection: () => tg?.HapticFeedback?.selectionChanged()
        };
        
        // Global haptic for all interactive elements
        document.addEventListener('click', (e) => {
            const target = e.target.closest('.btn, .list-item, .modal-close, .admin-stat-card');
            if (target) haptic.light();
        }, true);
        
        document.addEventListener('focus', (e) => {
            if (e.target.matches('.form-input, input, textarea, select')) haptic.selection();
        }, true);

        // –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–∏—á–Ω–∞—è, –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const ADMIN_IDS = ['7086128174']; // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–≤
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram WebApp
        const initData = tg?.initData; // –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
        const initDataUnsafe = tg?.initDataUnsafe;
        const currentUserId = initDataUnsafe?.user?.id?.toString();
        
        // Supabase –∫–ª–∏–µ–Ω—Ç
        const supabase = window.supabase?.createClient(
            'https://vmyzknraixtqvsceaujd.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXprbnJhaXh0cXZzY2VhdWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxODU0NzAsImV4cCI6MjA4MDc2MTQ3MH0.ame1hcZVX__x3WqREK18LJiAM9CuuQdS8FnbKIWMH1c'
        );

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –æ—Ç–∫–∞–∑–∞ –≤ –¥–æ—Å—Ç—É–ø–µ
        function showAccessDenied(message) {
            document.body.innerHTML = `
                <div style="position: fixed; inset: 0; background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%); display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 40px; text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 20px;">üîí</div>
                    <h1 style="color: #1b5e20; font-size: 28px; margin-bottom: 16px;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω</h1>
                    <p style="color: #388e3c; font-size: 16px; margin-bottom: 32px;">${message}</p>
                    <a href="https://t.me/giftl_robot" style="background: #34c759; color: white; padding: 16px 32px; border-radius: 12px; text-decoration: none; font-weight: 600;">
                        üì± –û—Ç–∫—Ä—ã—Ç—å –≤ Telegram
                    </a>
                </div>
            `;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º
        function requireAdmin() {
            if (!verifyInitData() || !ADMIN_IDS.includes(currentUserId)) {
                showToast('‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
                return false;
            }
            return true;
        }

        // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è initData (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram)
        function verifyInitData() {
            // initData –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –Ω–µ –±—ã—Ç—å –ø—É—Å—Ç—ã–º
            if (!initData || initData.length < 50) {
                console.error('Invalid initData: too short or missing');
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å hash (–ø–æ–¥–ø–∏—Å—å –æ—Ç Telegram)
            if (!initData.includes('hash=')) {
                console.error('Invalid initData: no hash');
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date (–¥–∞–Ω–Ω—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
            const authDateMatch = initData.match(/auth_date=(\d+)/);
            if (authDateMatch) {
                const authDate = parseInt(authDateMatch[1]);
                const now = Math.floor(Date.now() / 1000);
                if (now - authDate > 3600) { // 1 —á–∞—Å
                    console.error('Invalid initData: expired');
                    return false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ user_id –≤ initData —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å initDataUnsafe
            const userIdMatch = initData.match(/"id":(\d+)/);
            if (userIdMatch && userIdMatch[1] !== currentUserId) {
                console.error('Invalid initData: user_id mismatch');
                return false;
            }
            
            return true;
        }

        // Check admin access —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
        function checkAccess() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram
            const isTelegram = tg && initDataUnsafe?.user;
            
            if (!isTelegram) {
                showAccessDenied('–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram');
                return;
            }
            
            // 2. –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º initData
            if (!verifyInitData()) {
                showAccessDenied('–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                console.error('initData verification failed');
                return;
            }
            
            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤
            const isAdmin = ADMIN_IDS.includes(currentUserId);
            
            if (!isAdmin) {
                console.log('Access denied for user:', currentUserId);
                document.getElementById('accessDenied').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
                return;
            }
            
            // 4. –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∞
            console.log('Admin access granted:', currentUserId, 'initData length:', initData?.length);
            
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            if (isAdmin) {
                loadStats();
                loadVerifyRequests();
                loadVerifiedUsers();
                loadActivity();
                
                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                subscribeToRealtime();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ Supabase
        async function loadStats() {
            try {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                const { data: users, error: usersErr } = await supabase
                    .from('users')
                    .select('id', { count: 'exact' });
                
                // –ñ–µ–ª–∞–Ω–∏—è
                const { data: wishes, error: wishesErr } = await supabase
                    .from('wishes')
                    .select('id, reserved', { count: 'exact' });
                
                // –ì—Ä—É–ø–ø—ã –°–∞–Ω—Ç—ã
                const { data: groups, error: groupsErr } = await supabase
                    .from('santa_groups')
                    .select('id', { count: 'exact' });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('totalUsers').textContent = users?.length || 0;
                document.getElementById('totalWishes').textContent = wishes?.length || 0;
                document.getElementById('totalGroups').textContent = groups?.length || 0;
                document.getElementById('totalGifted').textContent = wishes?.filter(w => w.reserved)?.length || 0;
                
            } catch (err) {
                console.error('Stats error:', err);
                // Fallback –Ω–∞ localStorage
                const wishes = JSON.parse(localStorage.getItem('wishes') || '[]');
                const groups = JSON.parse(localStorage.getItem('santaGroups') || '[]');
                document.getElementById('totalWishes').textContent = wishes.length;
                document.getElementById('totalGroups').textContent = groups.length;
            }
        }
        
        // Realtime –ø–æ–¥–ø–∏—Å–∫–∞
        function subscribeToRealtime() {
            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            supabase
                .channel('admin-stats')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => loadStats())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'wishes' }, () => loadStats())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'santa_groups' }, () => loadStats())
                .subscribe();
        }

        async function loadVerifyRequests() {
            const list = document.getElementById('verifyRequestsList');
            let pending = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
            if (supabase) {
                try {
                    const { data, error } = await supabase
                        .from('verify_requests')
                        .select('*')
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false });
                    
                    if (data && !error) {
                        pending = data.map(r => ({
                            id: r.id,
                            oderId: r.telegram_id?.toString(),
                            userName: r.user_name,
                            username: r.username,
                            photoUrl: r.photo_url,
                            reason: r.reason,
                            socials: r.socials
                        }));
                    }
                } catch (err) {
                    console.error('Load requests error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            if (pending.length === 0) {
                const localRequests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
                pending = localRequests.filter(r => r.status === 'pending');
            }
            
            document.getElementById('requestsCount').textContent = pending.length;
            
            if (pending.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∑–∞—è–≤–æ–∫</div>';
                return;
            }
            
            list.innerHTML = pending.map(r => `
                <div class="list-item" style="flex-wrap: wrap; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 200px;">
                        <div class="list-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            ${r.photoUrl ? `<img src="${r.photoUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : 'üë§'}
                        </div>
                        <div class="list-content">
                            <div class="list-title">${r.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${r.username ? '(@' + r.username + ')' : ''}</div>
                            <div class="list-subtitle">ID: ${r.userId || r.id}</div>
                            <div class="list-subtitle" style="margin-top: 4px; color: var(--text-primary);">"${r.reason}"</div>
                            ${r.socials ? `<div class="list-subtitle">üîó ${r.socials}</div>` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-success" onclick="approveRequest('${r.id}')" style="padding: 8px 16px;">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="btn btn-danger" onclick="rejectRequest('${r.id}')" style="padding: 8px 16px;">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function approveRequest(requestId) {
            if (!requireAdmin()) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É
                    const { data: request } = await supabase
                        .from('verify_requests')
                        .select('*')
                        .eq('id', requestId)
                        .single();
                    
                    if (request) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
                        await supabase
                            .from('verify_requests')
                            .update({ status: 'approved' })
                            .eq('id', requestId);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ verified –≤ —Ç–∞–±–ª–∏—Ü–µ users
                        await supabase
                            .from('users')
                            .update({ verified: true })
                            .eq('telegram_id', request.telegram_id);
                        
                        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
                        const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
                        verified.push({
                            id: request.telegram_id?.toString(),
                            name: request.user_name,
                            username: request.username,
                            verifiedAt: Date.now()
                        });
                        localStorage.setItem('verifiedUsers', JSON.stringify(verified));
                        
                        logActivity('verify', `–û–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.user_name}`);
                        showToast('‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞');
                        loadVerifyRequests();
                        loadVerifiedUsers();
                        return;
                    }
                } catch (err) {
                    console.error('Approve error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === parseInt(requestId));
            
            if (request) {
                const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
                verified.push({
                    id: request.userId,
                    name: request.userName,
                    username: request.username,
                    verifiedAt: Date.now()
                });
                localStorage.setItem('verifiedUsers', JSON.stringify(verified));
                request.status = 'approved';
                localStorage.setItem('verifyRequests', JSON.stringify(requests));
                logActivity('verify', `–û–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.userName}`);
                showToast('‚úÖ –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞');
                loadVerifyRequests();
                loadVerifiedUsers();
            }
        }
        
        async function rejectRequest(requestId) {
            if (!requireAdmin()) return;
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    const { data: request } = await supabase
                        .from('verify_requests')
                        .select('user_name')
                        .eq('id', requestId)
                        .single();
                    
                    await supabase
                        .from('verify_requests')
                        .update({ status: 'rejected' })
                        .eq('id', requestId);
                    
                    logActivity('verify', `–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request?.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`);
                    showToast('‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                    loadVerifyRequests();
                    return;
                } catch (err) {
                    console.error('Reject error:', err);
                }
            }
            
            // Fallback –Ω–∞ localStorage
            const requests = JSON.parse(localStorage.getItem('verifyRequests') || '[]');
            const request = requests.find(r => r.id === requestId || r.id === parseInt(requestId));
            if (request) {
                request.status = 'rejected';
                localStorage.setItem('verifyRequests', JSON.stringify(requests));
                logActivity('verify', `–û—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∑–∞—è–≤–∫–∞: ${request.userName}`);
                showToast('‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
                loadVerifyRequests();
            }
        }

        function loadVerifiedUsers() {
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            const list = document.getElementById('verifiedList');
            
            if (verified.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            list.innerHTML = verified.map(u => `
                <div class="list-item">
                    <div class="list-icon green">‚úì</div>
                    <div class="list-content">
                        <div class="list-title">${u.name} ${u.username ? '(@' + u.username + ')' : ''}</div>
                        <div class="list-subtitle">ID: ${u.id}</div>
                    </div>
                    <button class="btn btn-text" onclick="removeVerification('${u.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function loadActivity() {
            const activity = JSON.parse(localStorage.getItem('adminActivity') || '[]');
            const list = document.getElementById('activityLog');
            
            if (activity.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
                return;
            }
            
            list.innerHTML = activity.slice(0, 10).map(a => `
                <div class="list-item">
                    <div class="list-icon ${a.type === 'broadcast' ? 'blue' : 'green'}">${a.type === 'broadcast' ? 'üì¢' : '‚úì'}</div>
                    <div class="list-content">
                        <div class="list-title">${a.action}</div>
                        <div class="list-subtitle">${new Date(a.time).toLocaleString('ru')}</div>
                    </div>
                </div>
            `).join('');
        }

        function logActivity(type, action) {
            const activity = JSON.parse(localStorage.getItem('adminActivity') || '[]');
            activity.unshift({ type, action, time: Date.now() });
            localStorage.setItem('adminActivity', JSON.stringify(activity.slice(0, 50)));
            loadActivity();
        }

        // Broadcast
        let broadcastPhotoData = null;
        
        function openBroadcastModal() { 
            document.getElementById('broadcastModal').classList.add('active'); 
            broadcastPhotoData = null;
            document.getElementById('broadcastPhotoPreview').style.backgroundImage = '';
            document.getElementById('broadcastPhotoPreview').classList.remove('has-image');
        }
        function closeBroadcastModal() { document.getElementById('broadcastModal').classList.remove('active'); }

        function handleBroadcastPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast('–ú–∞–∫—Å. 5MB'); return; }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                broadcastPhotoData = e.target.result;
                const preview = document.getElementById('broadcastPhotoPreview');
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }

        async function sendBroadcast() {
            if (!requireAdmin()) return;
            
            const message = document.getElementById('broadcastMessage').value.trim();
            if (!message) { showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'); return; }
            
            // –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –±–æ—Ç–∞
            const command = `/broadcast ${message}`;
            
            try {
                await navigator.clipboard.writeText(command);
                showToast('üìã –ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                setTimeout(() => {
                    alert(
                        'üì¢ –†–∞—Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:\n\n' +
                        '1. –ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä\n' +
                        '2. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ @giftl_robot\n' +
                        '3. –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ\n\n' +
                        '–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ñ–æ—Ç–æ - –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π /broadcast'
                    );
                }, 500);
                
            } catch (err) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
                alert(`–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É:\n\n${command}`);
            }
            
            logActivity('broadcast', `–†–∞—Å—Å—ã–ª–∫–∞: "${message.substring(0, 30)}${message.length > 30 ? '...' : ''}"`);
            closeBroadcastModal();
            document.getElementById('broadcastMessage').value = '';
            broadcastPhotoData = null;
        }

        // Verify
        function openVerifyModal() { document.getElementById('verifyModal').classList.add('active'); }
        function closeVerifyModal() { document.getElementById('verifyModal').classList.remove('active'); }

        async function verifyUser() {
            if (!requireAdmin()) return;
            
            const userId = document.getElementById('verifyUserId').value.trim();
            const userName = document.getElementById('verifyUserName').value.trim();
            
            if (!userId || !userName) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
            
            const verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            
            if (verified.some(u => u.id === userId)) {
                showToast('–£–∂–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({ verified: true })
                        .eq('telegram_id', parseInt(userId));
                } catch (err) {
                    console.error('Verify user error:', err);
                }
            }
            
            verified.push({ id: userId, name: userName, verifiedAt: Date.now() });
            localStorage.setItem('verifiedUsers', JSON.stringify(verified));
            
            logActivity('verify', `–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: ${userName}`);
            showToast('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
            closeVerifyModal();
            loadVerifiedUsers();
            loadStats();
            
            document.getElementById('verifyUserId').value = '';
            document.getElementById('verifyUserName').value = '';
        }

        function removeVerification(userId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é?')) return;
            
            let verified = JSON.parse(localStorage.getItem('verifiedUsers') || '[]');
            verified = verified.filter(u => u.id !== userId);
            localStorage.setItem('verifiedUsers', JSON.stringify(verified));
            
            logActivity('verify', '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
            showToast('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
            loadVerifiedUsers();
            loadStats();
        }

        function exportData() {
            const data = {
                wishes: JSON.parse(localStorage.getItem('wishes') || '[]'),
                groups: JSON.parse(localStorage.getItem('santaGroups') || '[]'),
                verified: JSON.parse(localStorage.getItem('verifiedUsers') || '[]'),
                activity: JSON.parse(localStorage.getItem('adminActivity') || '[]'),
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `giftly-export-${Date.now()}.json`;
            a.click();
            
            showToast('üì• –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
        }

        function clearAllData() {
            if (!requireAdmin()) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) return;
            
            localStorage.clear();
            showToast('üóëÔ∏è –î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
            loadStats();
            loadVerifiedUsers();
            loadActivity();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        }

        // ===== TASKS MANAGEMENT =====
        function openTaskModal() {
            document.getElementById('taskModal').classList.add('active');
        }
        
        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            // Reset form
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDesc').value = '';
            document.getElementById('taskLink').value = '';
            document.getElementById('taskReward').value = '3';
            document.getElementById('taskIcon').value = 'üì¢';
        }
        
        async function saveTask() {
            if (!requireAdmin()) return;
            
            const task = {
                id: 'task_' + Date.now(),
                type: document.getElementById('taskType').value,
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDesc').value.trim(),
                link: document.getElementById('taskLink').value.trim(),
                reward: parseInt(document.getElementById('taskReward').value) || 3,
                icon: document.getElementById('taskIcon').value || 'üì¢',
                active: true,
                created_at: new Date().toISOString()
            };
            
            if (!task.title) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    await supabase.from('tasks').insert([task]);
                } catch (err) {
                    console.error('Save task error:', err);
                }
            }
            
            // –¢–∞–∫–∂–µ –≤ localStorage
            const tasks = JSON.parse(localStorage.getItem('adminTasks') || '[]');
            tasks.push(task);
            localStorage.setItem('adminTasks', JSON.stringify(tasks));
            
            logActivity('task', `–°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞–Ω–∏–µ: ${task.title}`);
            showToast('‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
            closeTaskModal();
            loadTasks();
        }
        
        async function loadTasks() {
            const list = document.getElementById('tasksList');
            let tasks = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
            if (supabase) {
                try {
                    const { data } = await supabase
                        .from('tasks')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (data) tasks = data;
                } catch (err) {
                    console.error('Load tasks error:', err);
                }
            }
            
            // Fallback
            if (tasks.length === 0) {
                tasks = JSON.parse(localStorage.getItem('adminTasks') || '[]');
            }
            
            if (tasks.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div>';
                return;
            }
            
            list.innerHTML = tasks.map(t => `
                <div class="list-item">
                    <div class="list-icon gold">${t.icon}</div>
                    <div class="list-content">
                        <div class="list-title">${t.title}</div>
                        <div class="list-subtitle">+${t.reward} üéüÔ∏è ‚Ä¢ ${t.type}</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteTask('${t.id}')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        async function deleteTask(taskId) {
            if (!requireAdmin()) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ?')) return;
            
            if (supabase) {
                try {
                    await supabase.from('tasks').delete().eq('id', taskId);
                } catch (err) {
                    console.error('Delete task error:', err);
                }
            }
            
            let tasks = JSON.parse(localStorage.getItem('adminTasks') || '[]');
            tasks = tasks.filter(t => t.id !== taskId);
            localStorage.setItem('adminTasks', JSON.stringify(tasks));
            
            showToast('üóëÔ∏è –ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
            loadTasks();
        }

        // ===== RAFFLES MANAGEMENT =====
        function openRaffleModal() {
            document.getElementById('raffleModal').classList.add('active');
            // Set default end date to next Sunday 20:00
            const nextSunday = new Date();
            nextSunday.setDate(nextSunday.getDate() + (7 - nextSunday.getDay()) % 7 || 7);
            nextSunday.setHours(20, 0, 0, 0);
            document.getElementById('raffleEndDate').value = nextSunday.toISOString().slice(0, 16);
        }
        
        function closeRaffleModal() {
            document.getElementById('raffleModal').classList.remove('active');
        }
        
        async function saveRaffle() {
            if (!requireAdmin()) return;
            
            const raffle = {
                id: 'raffle_' + Date.now(),
                title: document.getElementById('raffleTitle').value.trim(),
                description: document.getElementById('raffleDesc').value.trim(),
                prize_type: document.getElementById('rafflePrizeType').value,
                prize_value: document.getElementById('rafflePrizeValue').value.trim(),
                end_date: document.getElementById('raffleEndDate').value,
                min_tickets: parseInt(document.getElementById('raffleMinTickets').value) || 1,
                status: 'active',
                participants: [],
                winner_id: null,
                created_at: new Date().toISOString()
            };
            
            if (!raffle.title) {
                showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
            if (supabase) {
                try {
                    await supabase.from('raffles').insert([raffle]);
                } catch (err) {
                    console.error('Save raffle error:', err);
                }
            }
            
            // –¢–∞–∫–∂–µ –≤ localStorage
            const raffles = JSON.parse(localStorage.getItem('adminRaffles') || '[]');
            raffles.push(raffle);
            localStorage.setItem('adminRaffles', JSON.stringify(raffles));
            
            logActivity('raffle', `–°–æ–∑–¥–∞–Ω —Ä–æ–∑—ã–≥—Ä—ã—à: ${raffle.title}`);
            showToast('üéÅ –†–æ–∑—ã–≥—Ä—ã—à —Å–æ–∑–¥–∞–Ω');
            closeRaffleModal();
            loadRaffles();
        }
        
        async function loadRaffles() {
            const list = document.getElementById('rafflesList');
            let raffles = [];
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Supabase
            if (supabase) {
                try {
                    const { data } = await supabase
                        .from('raffles')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (data) raffles = data;
                } catch (err) {
                    console.error('Load raffles error:', err);
                }
            }
            
            // Fallback
            if (raffles.length === 0) {
                raffles = JSON.parse(localStorage.getItem('adminRaffles') || '[]');
            }
            
            if (raffles.length === 0) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π</div>';
                return;
            }
            
            const prizeIcons = { nft: 'üñºÔ∏è', gift: 'üéÅ', premium: '‚≠ê', money: 'üí∞', other: 'üì¶' };
            const statusColors = { active: 'green', completed: 'blue', cancelled: 'red' };
            const statusLabels = { active: '–ê–∫—Ç–∏–≤–µ–Ω', completed: '–ó–∞–≤–µ—Ä—à—ë–Ω', cancelled: '–û—Ç–º–µ–Ω—ë–Ω' };
            
            list.innerHTML = raffles.map(r => {
                const endDate = new Date(r.end_date);
                const isEnded = endDate < new Date();
                const timeLeft = isEnded ? '–ó–∞–≤–µ—Ä—à—ë–Ω' : formatTimeLeft(endDate);
                
                return `
                    <div class="list-item" style="flex-wrap: wrap; gap: 8px;">
                        <div class="list-icon purple">${prizeIcons[r.prize_type] || 'üéÅ'}</div>
                        <div class="list-content" style="flex: 1; min-width: 150px;">
                            <div class="list-title">${r.title}</div>
                            <div class="list-subtitle">${r.prize_value || '–ü—Ä–∏–∑'} ‚Ä¢ ${timeLeft}</div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <span class="group-badge ${statusColors[r.status]}">${statusLabels[r.status]}</span>
                            ${r.status === 'active' ? `
                                <button class="btn btn-success" onclick="drawWinner('${r.id}')" style="padding: 6px 10px; font-size: 11px;">üé≤ –†–æ–∑—ã–≥—Ä—ã—à</button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteRaffle('${r.id}')" style="padding: 6px 10px; font-size: 11px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTimeLeft(date) {
            const diff = date - new Date();
            if (diff <= 0) return '–ó–∞–≤–µ—Ä—à—ë–Ω';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return `${days}–¥ ${hours}—á`;
        }
        
        async function drawWinner(raffleId) {
            if (!requireAdmin()) return;
            if (!confirm('–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à –∏ –≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è?')) return;
            
            showToast('üé≤ –í—ã–±–∏—Ä–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è...');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –±–∏–ª–µ—Ç–∏–∫–∞–º–∏
            let participants = [];
            
            if (supabase) {
                try {
                    const { data: tickets } = await supabase
                        .from('user_tickets')
                        .select('user_id')
                        .is('used_in_raffle', null);
                    
                    if (tickets && tickets.length > 0) {
                        // –ö–∞–∂–¥—ã–π –±–∏–ª–µ—Ç–∏–∫ = 1 —à–∞–Ω—Å
                        participants = tickets.map(t => t.user_id);
                    }
                } catch (err) {
                    console.error('Get participants error:', err);
                }
            }
            
            if (participants.length === 0) {
                showToast('‚ùå –ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –±–∏–ª–µ—Ç–∏–∫–∞–º–∏');
                return;
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
            const winnerUserId = participants[Math.floor(Math.random() * participants.length)];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à
            if (supabase) {
                try {
                    await supabase
                        .from('raffles')
                        .update({ 
                            status: 'completed', 
                            winner_id: winnerUserId 
                        })
                        .eq('id', raffleId);
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∏–∫–∏
                    await supabase
                        .from('user_tickets')
                        .update({ used_in_raffle: raffleId })
                        .is('used_in_raffle', null);
                        
                } catch (err) {
                    console.error('Update raffle error:', err);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º localStorage
            let raffles = JSON.parse(localStorage.getItem('adminRaffles') || '[]');
            raffles = raffles.map(r => {
                if (r.id === raffleId) {
                    r.status = 'completed';
                    r.winner_id = winnerUserId;
                }
                return r;
            });
            localStorage.setItem('adminRaffles', JSON.stringify(raffles));
            
            logActivity('raffle', `–†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à—ë–Ω! –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerUserId}`);
            showToast(`üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω!`);
            loadRaffles();
        }
        
        async function deleteRaffle(raffleId) {
            if (!requireAdmin()) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–æ–∑—ã–≥—Ä—ã—à?')) return;
            
            if (supabase) {
                try {
                    await supabase.from('raffles').delete().eq('id', raffleId);
                } catch (err) {
                    console.error('Delete raffle error:', err);
                }
            }
            
            let raffles = JSON.parse(localStorage.getItem('adminRaffles') || '[]');
            raffles = raffles.filter(r => r.id !== raffleId);
            localStorage.setItem('adminRaffles', JSON.stringify(raffles));
            
            showToast('üóëÔ∏è –†–æ–∑—ã–≥—Ä—ã—à —É–¥–∞–ª—ë–Ω');
            loadRaffles();
        }

        // ===== USER MANAGEMENT =====
        function openUserSearchModal() {
            document.getElementById('userSearchModal').classList.add('active');
            document.getElementById('userSearchResult').innerHTML = '';
        }
        
        function closeUserSearchModal() {
            document.getElementById('userSearchModal').classList.remove('active');
        }
        
        function openBlockUserModal() {
            document.getElementById('blockUserModal').classList.add('active');
        }
        
        function closeBlockUserModal() {
            document.getElementById('blockUserModal').classList.remove('active');
        }
        
        async function searchUser() {
            const query = document.getElementById('userSearchQuery').value.trim();
            if (!query) return;
            
            const resultDiv = document.getElementById('userSearchResult');
            resultDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">–ü–æ–∏—Å–∫...</div>';
            
            if (!supabase) {
                resultDiv.innerHTML = '<div style="color: var(--ios-red);">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>';
                return;
            }
            
            try {
                let user = null;
                
                // –ü–æ–∏—Å–∫ –ø–æ telegram_id
                if (/^\d+$/.test(query)) {
                    const { data } = await supabase
                        .from('users')
                        .select('*')
                        .eq('telegram_id', parseInt(query))
                        .single();
                    user = data;
                } else {
                    // –ü–æ–∏—Å–∫ –ø–æ username
                    const username = query.replace('@', '');
                    const { data } = await supabase
                        .from('users')
                        .select('*')
                        .eq('username', username)
                        .single();
                    user = data;
                }
                
                if (!user) {
                    resultDiv.innerHTML = '<div style="color: var(--text-secondary);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="card" style="margin: 0;">
                        <div class="card-body">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--ios-green); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white;">
                                    ${user.photo_url ? `<img src="${user.photo_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : 'üë§'}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${user.verified ? '‚úì' : ''}</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">@${user.username || '–Ω–µ—Ç'} ‚Ä¢ ID: ${user.telegram_id}</div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                üéüÔ∏è –ë–∏–ª–µ—Ç–∏–∫–æ–≤: ${user.tickets || 0} ‚Ä¢ 
                                ${user.is_blocked ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'} ‚Ä¢
                                ${user.verified ? '‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' : ''}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${!user.is_blocked ? `
                                    <button class="btn btn-danger" onclick="blockUserById('${user.telegram_id}')" style="font-size: 12px;">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                ` : `
                                    <button class="btn btn-success" onclick="unblockUser('${user.telegram_id}')" style="font-size: 12px;">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                                `}
                                ${!user.verified ? `
                                    <button class="btn btn-primary" onclick="verifyUserById('${user.telegram_id}')" style="font-size: 12px;">‚úì –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å</button>
                                ` : `
                                    <button class="btn btn-secondary" onclick="unverifyUser('${user.telegram_id}')" style="font-size: 12px;">‚úó –°–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É</button>
                                `}
                                <button class="btn btn-secondary" onclick="window.open('public-profile.html?id=${user.telegram_id}')" style="font-size: 12px;">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Search error:', err);
                resultDiv.innerHTML = '<div style="color: var(--ios-red);">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            }
        }
        
        async function blockUser() {
            // –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞
            if (!requireAdmin()) return;
            
            const userId = document.getElementById('blockUserId').value.trim();
            const reason = document.getElementById('blockReason').value.trim();
            const duration = document.getElementById('blockDuration').value;
            
            if (!userId) {
                showToast('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            // –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞
            if (ADMIN_IDS.includes(userId)) {
                showToast('‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞');
                return;
            }
            
            let blockedUntil = null;
            if (duration !== 'forever') {
                const days = parseInt(duration);
                blockedUntil = new Date();
                blockedUntil.setDate(blockedUntil.getDate() + days);
            }
            
            const restrictions = {
                can_create_wishes: !document.getElementById('restrictWishes').checked,
                can_join_santa: !document.getElementById('restrictSanta').checked,
                can_join_raffles: !document.getElementById('restrictRaffles').checked
            };
            
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({
                            is_blocked: true,
                            blocked_reason: reason,
                            blocked_at: new Date().toISOString(),
                            blocked_until: blockedUntil?.toISOString() || null,
                            restrictions: restrictions
                        })
                        .eq('telegram_id', parseInt(userId));
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                    await supabase.from('admin_logs').insert([{
                        admin_id: parseInt(currentUserId),
                        action: 'block_user',
                        target_user_id: parseInt(userId),
                        details: { reason, duration, restrictions }
                    }]);
                    
                    logActivity('block', `–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${userId}`);
                    showToast('üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    closeBlockUserModal();
                } catch (err) {
                    console.error('Block error:', err);
                    showToast('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
                }
            }
        }
        
        async function blockUserById(telegramId) {
            document.getElementById('blockUserId').value = telegramId;
            closeUserSearchModal();
            openBlockUserModal();
        }
        
        async function unblockUser(telegramId) {
            if (!requireAdmin()) return;
            if (!confirm('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({
                            is_blocked: false,
                            blocked_reason: null,
                            blocked_at: null,
                            blocked_until: null,
                            restrictions: {}
                        })
                        .eq('telegram_id', parseInt(telegramId));
                    
                    logActivity('unblock', `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${telegramId}`);
                    showToast('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
                    searchUser(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                } catch (err) {
                    console.error('Unblock error:', err);
                }
            }
        }
        
        async function verifyUserById(telegramId) {
            if (!requireAdmin()) return;
            
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({ verified: true })
                        .eq('telegram_id', parseInt(telegramId));
                    
                    logActivity('verify', `–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: ${telegramId}`);
                    showToast('‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω');
                    searchUser();
                } catch (err) {
                    console.error('Verify error:', err);
                }
            }
        }
        
        async function unverifyUser(telegramId) {
            if (!requireAdmin()) return;
            if (!confirm('–°–Ω—è—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é?')) return;
            
            if (supabase) {
                try {
                    await supabase
                        .from('users')
                        .update({ verified: false })
                        .eq('telegram_id', parseInt(telegramId));
                    
                    logActivity('unverify', `–°–Ω—è—Ç–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: ${telegramId}`);
                    showToast('‚úó –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–Ω—è—Ç–∞');
                    searchUser();
                } catch (err) {
                    console.error('Unverify error:', err);
                }
            }
        }
        
        async function loadBlockedUsers() {
            const list = document.getElementById('blockedUsersList');
            list.style.display = 'block';
            list.innerHTML = '<div class="list-item" style="justify-content: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            if (!supabase) {
                list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ë–∞–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>';
                return;
            }
            
            try {
                const { data: users } = await supabase
                    .from('users')
                    .select('*')
                    .eq('is_blocked', true)
                    .order('blocked_at', { ascending: false });
                
                if (!users || users.length === 0) {
                    list.innerHTML = '<div class="list-item" style="justify-content: center; color: var(--text-secondary);">–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>';
                    return;
                }
                
                list.innerHTML = users.map(u => `
                    <div class="list-item" style="flex-wrap: wrap; gap: 8px;">
                        <div class="list-icon red">üö´</div>
                        <div class="list-content" style="flex: 1; min-width: 150px;">
                            <div class="list-title">${u.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} (@${u.username || '–Ω–µ—Ç'})</div>
                            <div class="list-subtitle">ID: ${u.telegram_id} ‚Ä¢ ${u.blocked_reason || '–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã'}</div>
                        </div>
                        <button class="btn btn-success" onclick="unblockUser('${u.telegram_id}')" style="padding: 6px 12px; font-size: 12px;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load blocked error:', err);
                list.innerHTML = '<div class="list-item" style="color: var(--ios-red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        checkAccess();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
        setTimeout(() => {
            if (document.getElementById('adminPanel').style.display !== 'none') {
                loadTasks();
                loadRaffles();
            }
        }, 500);
    </script>
    <script src="config.js"></script>
</body>
</html>
